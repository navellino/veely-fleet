<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layoutNavBar :: layout(~{::title}, ~{::body}, ~{::cssblock}, ~{::navbar})}">
<head>
    <title th:text="${isEdit ? 'Modifica Configurazione Aziendale' : 'Nuova Configurazione Aziendale'} + ' – Veely'">Configurazione Aziendale – Veely</title>
</head>
<th:block th:fragment="navbar">
</th:block>
<body>

<main class="container-fluid my-4 flex-fill">
    
    <!-- Header -->
    <div class="bg-primary text-white rounded p-4 mb-4">
        <h1 th:text="${isEdit ? 'Modifica Configurazione Aziendale' : 'Nuova Configurazione Aziendale'}">Configurazione Aziendale</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/settings/company}">Configurazioni</a></li>
                <li class="breadcrumb-item active" th:text="${isEdit ? 'Modifica' : 'Nuova'}">Nuova</li>
            </ol>
        </nav>
    </div>

    <!-- Action Bar -->
     <div class="d-flex justify-content-between align-items-center bg-white rounded p-3 mb-4 shadow-sm border">
        <div>
            <a class="btn btn-outline-secondary" th:href="@{/settings/company}">
                <i class="bi bi-arrow-left me-2"></i> Torna alla Lista
            </a>
        </div>
        
        <div class="d-flex gap-2">
            <button type="submit" form="companyForm" class="btn btn-primary">
                <i class="bi bi-check-lg me-2"></i> 
                <span th:text="${isEdit ? 'Salva Modifiche' : 'Crea Configurazione'}">Salva</span>
            </button>
            <a class="btn btn-secondary" th:href="@{/settings/company}">
                <i class="bi bi-x-lg me-2"></i> Annulla
            </a>
        </div>
    </div>

    <!-- Alert Messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="companyTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true">
                <i class="bi bi-building me-2"></i>Informazioni Base
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">
                <i class="bi bi-telephone me-2"></i>Contatti
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="legal-tab" data-bs-toggle="tab" data-bs-target="#legal" type="button" role="tab" aria-controls="legal" aria-selected="false">
                <i class="bi bi-file-text me-2"></i>Dati Fiscali
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="branding-tab" data-bs-toggle="tab" data-bs-target="#branding" type="button" role="tab" aria-controls="branding" aria-selected="false">
                <i class="bi bi-palette me-2"></i>Branding
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="companyTabsContent">
        
        <!-- ============ TAB 1: INFORMAZIONI BASE ============ -->
        <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
            <form id="companyForm" th:object="${companyInfo}"
                  th:action="${isEdit} ? @{/settings/company/{id}/edit(id=${companyInfo.id})} : @{/settings/company/new}"
                  method="post" class="needs-validation" novalidate>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
               <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Informazioni Aziendali
                        </h5>
                    </div>
                     <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                 <label class="form-label">Nome Azienda <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{companyName}" required 
                                       placeholder="Es. Veely SRL">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Forma Giuridica</label>
                                <select class="form-select" th:field="*{legalForm}">
                                    <option value="">Seleziona...</option>
                                    <option value="SRL">SRL</option>
                                    <option value="SPA">SPA</option>
                                    <option value="SRLS">SRLS</option>
                                    <option value="SAS">SAS</option>
                                    <option value="SNC">SNC</option>
                                    <option value="Ditta Individuale">Ditta Individuale</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descrizione Attività</label>
                                <textarea class="form-control" th:field="*{businessDescription}" rows="3"
                                          placeholder="Breve descrizione dell'attività aziendale"></textarea>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3">
                            <i class="bi bi-geo-alt me-2"></i>
                            Sede Legale
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Via/Piazza</label>
                                <input type="text" class="form-control" th:field="*{legalStreet}" 
                                       placeholder="Es. Via Roma">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">N. Civico</label>
                                <input type="text" class="form-control" th:field="*{legalCivicNumber}" 
                                       placeholder="123">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">CAP</label>
                                <input type="text" class="form-control" th:field="*{legalPostalCode}" 
                                       placeholder="20100">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Provincia</label>
                                <input type="text" class="form-control" th:field="*{legalProvince}" 
                                       placeholder="MI">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Città</label>
                                <input type="text" class="form-control" th:field="*{legalCity}" 
                                       placeholder="Milano">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Paese</label>
                                <input type="text" class="form-control" th:field="*{legalCountry}" 
                                       value="Italia" placeholder="Italia">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- ============ TAB 2: CONTATTI ============ -->
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
            <form id="contactForm" th:object="${companyInfo}"
                  th:action="${isEdit} ? @{/settings/company/{id}/edit(id=${companyInfo.id})} : @{/settings/company/new}"
                  method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-telephone me-2"></i>
                            Informazioni di Contatto
                        </h5>
                    </div>
                     <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Telefono Principale</label>
                                <input type="tel" class="form-control" th:field="*{primaryPhone}" 
                                       placeholder="+39 02 1234567">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Telefono Secondario</label>
                                <input type="tel" class="form-control" th:field="*{secondaryPhone}" 
                                       placeholder="+39 02 7654321">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email Principale</label>
                                <input type="email" class="form-control" th:field="*{primaryEmail}" 
                                       placeholder="info@azienda.it">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email Secondaria</label>
                                <input type="email" class="form-control" th:field="*{secondaryEmail}" 
                                       placeholder="admin@azienda.it">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">PEC</label>
                                <input type="email" class="form-control" th:field="*{pecEmail}" 
                                       placeholder="azienda@pec.it">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sito Web</label>
                                <input type="url" class="form-control" th:field="*{website}" 
                                       placeholder="https://www.azienda.it">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fax</label>
                                <input type="tel" class="form-control" th:field="*{faxNumber}" 
                                       placeholder="+39 02 1234568">
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-2"></i>Salva Contatti
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- ============ TAB 3: DATI FISCALI ============ -->
        <div class="tab-pane fade" id="legal" role="tabpanel" aria-labelledby="legal-tab">
            <form id="legalForm" th:object="${companyInfo}"
                  th:action="${isEdit} ? @{/settings/company/{id}/edit(id=${companyInfo.id})} : @{/settings/company/new}"
                  method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-file-text me-2"></i>
                            Dati Fiscali e Legali
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Partita IVA</label>
                                <input type="text" class="form-control" th:field="*{vatNumber}" 
                                       placeholder="IT12345678901">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Codice Fiscale</label>
                                <input type="text" class="form-control" th:field="*{taxCode}" 
                                       placeholder="12345678901">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Numero REA</label>
                                <input type="text" class="form-control" th:field="*{reaNumber}" 
                                       placeholder="MI-1234567">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Camera di Commercio</label>
                                <input type="text" class="form-control" th:field="*{chamberOfCommerceCity}" 
                                       placeholder="Milano">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Capitale Sociale</label>
                                <input type="text" class="form-control" th:field="*{shareCapital}" 
                                       placeholder="€ 10.000,00">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Codice ATECO</label>
                                <input type="text" class="form-control" th:field="*{economicActivityCode}" 
                                       placeholder="62.01.00">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Descrizione Attività ATECO</label>
                                <input type="text" class="form-control" th:field="*{economicActivityDescription}" 
                                       placeholder="Produzione di software non connesso all'edizione">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3">
                            <i class="bi bi-bank me-2"></i>
                            Dati Bancari
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome Banca</label>
                                <input type="text" class="form-control" th:field="*{bankName}" 
                                       placeholder="Intesa Sanpaolo">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Filiale</label>
                                <input type="text" class="form-control" th:field="*{bankBranch}" 
                                       placeholder="Milano Centro">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">IBAN</label>
                                <input type="text" class="form-control" th:field="*{iban}" 
                                       placeholder="IT60 X054 2811 1010 0000 0123 456">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">SWIFT/BIC</label>
                                <input type="text" class="form-control" th:field="*{swift}" 
                                       placeholder="BCITITMM">
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-2"></i>Salva Dati Fiscali
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- ============ TAB 4: BRANDING ============ -->
        <div class="tab-pane fade" id="branding" role="tabpanel" aria-labelledby="branding-tab">
           <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-palette me-2"></i>
                        Logo e Branding
                    </h5>
                </div>
                 <div class="card-body">
                    
                    <!-- Logo Upload solo in edit mode -->
                    <div th:if="${isEdit}">
                        <div class="row g-4">
                            
                            <!-- LOGO AZIENDALE -->
                            <div class="col-md-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-image me-2"></i>
                                    Logo Aziendale
                                </h6>
                                
                                <!-- Anteprima logo attuale -->
                                <div class="position-relative d-flex align-items-center justify-content-center border border-2 border-secondary rounded bg-light mb-3">
                                    <div th:if="${hasLogo}" class="position-relative d-flex flex-column align-items-center p-3">
                                        <img th:src="@{|/settings/company/files/${companyInfo.logoPath}|}" 
                                             alt="Logo attuale" 
                                             class="img-fluid rounded shadow-sm bg-white p-2 mb-2">
                                        <div class="position-absolute top-0 end-0">
                                            <small class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>Logo attivo
                                            </small>
                                        </div>
                                    </div>
                                    <div th:unless="${hasLogo}" class="text-center p-4 text-muted">
                                        <i class="bi bi-image display-4 text-muted"></i>
                                        <p class="text-muted mb-0">Nessun logo caricato</p>
                                    </div>
                                </div>
                                
                                <!-- Form upload logo -->
                                <form th:action="@{|/settings/company/${companyInfo.id}/upload-logo|}" 
                                      method="post" 
                                      enctype="multipart/form-data">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    
                                     <div class="border border-2 border-secondary rounded p-4 text-center bg-light">
                                        <input type="file" 
                                               class="form-control mb-3" 
                                               name="logoFile" 
                                               accept="image/*"
                                               required>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-upload me-1"></i>Carica Logo
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- LOGO INTESTAZIONI -->
                            <div class="col-md-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-file-earmark-image me-2"></i>
                                    Logo Intestazioni
                                </h6>
                                
                                <div class="position-relative d-flex align-items-center justify-content-center border border-2 border-secondary rounded bg-light mb-3">
                                    <div th:if="${hasHeaderLogo}" class="position-relative d-flex flex-column align-items-center p-3">
                                        <img th:src="@{|/settings/company/files/${companyInfo.headerLogoPath}|}" 
                                             alt="Logo intestazione" 
                                              class="img-fluid rounded shadow-sm bg-white p-2 mb-2">
                                        <div class="position-absolute top-0 end-0">
                                            <small class="badge bg-info">
                                                <i class="bi bi-check-circle me-1"></i>Intestazione
                                            </small>
                                        </div>
                                    </div>
                                    <div th:unless="${hasHeaderLogo}" class="text-center p-4 text-muted">
                                        <i class="bi bi-file-earmark-image display-4 text-muted"></i>
                                        <p class="text-muted mb-0">Nessun logo intestazione</p>
                                    </div>
                                </div>
                                
                                <form th:action="@{|/settings/company/${companyInfo.id}/upload-header-logo|}" 
                                      method="post" 
                                      enctype="multipart/form-data">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    
                                    <div class="border border-2 border-secondary rounded p-4 text-center bg-light">
                                        <input type="file" 
                                               class="form-control mb-3" 
                                               name="headerLogoFile" 
                                               accept="image/*"
                                               required>
                                        
                                        <button type="submit" class="btn btn-info">
                                            <i class="bi bi-upload me-1"></i>Carica
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- WATERMARK -->
                            <div class="col-md-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-droplet me-2"></i>
                                    Watermark
                                </h6>
                                
                                 <div class="position-relative d-flex align-items-center justify-content-center border border-2 border-secondary rounded bg-light mb-3">
                                    <div th:if="${hasWatermark}" class="position-relative d-flex flex-column align-items-center p-3">
                                        <img th:src="@{|/settings/company/files/${companyInfo.watermarkPath}|}" 
                                             alt="Watermark" 
                                              class="img-fluid rounded shadow-sm bg-white p-2 mb-2">
                                        <div class="position-absolute top-0 end-0">
                                            <small class="badge bg-secondary">
                                                <i class="bi bi-droplet me-1"></i>Watermark
                                            </small>
                                        </div>
                                    </div>
                                    <div th:unless="${hasWatermark}" class="text-center p-4 text-muted">
                                        <i class="bi bi-droplet display-4 text-muted"></i>
                                        <p class="text-muted mb-0">Nessun watermark</p>
                                    </div>
                                </div>
                                
                                <form th:action="@{|/settings/company/${companyInfo.id}/upload-watermark|}" 
                                      method="post" 
                                      enctype="multipart/form-data">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    
                                   <div class="border border-2 border-secondary rounded p-4 text-center bg-light">
                                        <input type="file" 
                                               class="form-control mb-3" 
                                               name="watermarkFile" 
                                               accept="image/*"
                                               required>
                                        
                                        <button type="submit" class="btn btn-secondary">
                                            <i class="bi bi-upload me-1"></i>Carica
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                        </div>
                    </div>
                    
                    <div th:unless="${isEdit}" class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        I loghi potranno essere caricati dopo aver salvato la configurazione.
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Colors & Settings Form -->
                    <form th:object="${companyInfo}"
                          th:action="${isEdit} ? @{/settings/company/{id}/edit(id=${companyInfo.id})} : @{/settings/company/new}"
                          method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        
                        <!-- Colors -->
                        <h6 class="mb-3">
                            <i class="bi bi-palette2 me-2"></i>
                            Colori Aziendali
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Colore Primario</label>
                                <input type="color" class="form-control form-control-color" th:field="*{primaryColor}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Colore Secondario</label>
                                <input type="color" class="form-control form-control-color" th:field="*{secondaryColor}">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Document Settings -->
                        <h6 class="mb-3">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            Impostazioni Documenti
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" th:field="*{showLogoInDocuments}">
                                    <label class="form-check-label">
                                        Mostra logo nei documenti
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" th:field="*{showAddressInDocuments}">
                                    <label class="form-check-label">
                                        Mostra indirizzo nei documenti
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" th:field="*{showContactsInDocuments}">
                                    <label class="form-check-label">
                                        Mostra contatti nei documenti
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" th:field="*{showTaxInfoInDocuments}">
                                    <label class="form-check-label">
                                        Mostra dati fiscali nei documenti
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-2"></i>Salva Impostazioni
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</main>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Form caricato - versione con form separati');
    
    // Form validation per tutti i form
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(event) {
            if (form.classList.contains('needs-validation') && !form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });
    
    // Log form uploads con maggiori dettagli
    document.querySelectorAll('form[enctype="multipart/form-data"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            console.log('=== UPLOAD FORM SUBMIT ===');
            console.log('Action URL:', this.action);
            console.log('Method:', this.method);
            
            const fileInput = this.querySelector('input[type="file"]');
            if (fileInput && fileInput.files[0]) {
                const file = fileInput.files[0];
                console.log('File name:', file.name);
                console.log('File size:', file.size + ' bytes');
                console.log('File type:', file.type);
                console.log('Input name:', fileInput.name);
            } else {
                console.log('Nessun file selezionato');
            }
            
            // CSRF Token check
            const csrfInput = this.querySelector('input[name="_csrf"]');
            if (csrfInput) {
                console.log('CSRF token presente:', csrfInput.value.substring(0, 10) + '...');
            } else {
                console.log('ATTENZIONE: CSRF token mancante!');
            }
            
            console.log('=== END UPLOAD FORM ===');
        });
    });
});
</script>

</body>
</html>