<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layoutNavBar :: layout(~{::title}, ~{::body}, ~{::cssblock}, ~{::navbar})}">
<head>
    <title>Elenco Veicoli ‚Äì Veely</title>
    <th:block th:fragment="cssblock">
    	<link rel="stylesheet" th:href="@{/css/vehicle-page.css}">
    </th:block>
</head>
<th:block th:fragment="navbar">
	 <!-- Modern Page Header (margini ridotti) -->
    <div class="vehicles-page-header" style="margin-bottom: 1.5rem;">
        <div class="header-main">
            <div class="header-icon">
                <i class="bi bi-car-front-fill"></i>
            </div>
            <div class="header-content">
                <h1 class="page-title">Gestione Flotta</h1>
                <p class="page-subtitle">Monitora e gestisci tutti i veicoli della tua flotta aziendale</p>
            </div>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" th:text="${totalVehicles ?: 0}">0</div>
                <div class="stat-label">Totale Veicoli</div>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <div class="stat-value text-success" th:text="${statusStats['IN_SERVICE'] ?: 0}">0</div>
                <div class="stat-label">Operativi</div>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
                <div class="stat-value text-warning" th:text="${statusStats['IN_MAINTENANCE'] ?: 0}">0</div>
                <div class="stat-label">In Manutenzione</div>
            </div>
        </div>
    </div>
</th:block>
<body>
	<div xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
   

    <!-- Advanced Filter Bar (margini ridotti) -->
    <div class="vehicles-filter-section" style="margin-bottom: 1.5rem;">
        <div class="filter-card">
            <div class="filter-header">
                <div class="filter-title">
                    <i class="bi bi-funnel me-2"></i>
                    Filtri Avanzati
                </div>
                <button class="filter-toggle-btn" id="filterToggle">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            
            <div class="filter-content" id="filterContent">
                <form method="get" th:action="@{/fleet/vehicles}">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-search me-1"></i>
                                Ricerca Globale
                            </label>
                            <div class="search-input-container">
                                <input type="text" class="form-control search-input" 
                                       name="search"
                                       th:value="${currentFilters['search']}"
                                       placeholder="Cerca per targa, marca, modello, chassis..." 
                                       id="searchInput">
                                <i class="bi bi-search search-icon"></i>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-circle-fill me-1"></i>
                                Stato Veicolo
                            </label>
                            <select class="form-select filter-select" name="status" id="statusFilter">
                                <option value="">Tutti gli stati</option>
                                <option value="IN_SERVICE" th:selected="${currentFilters['status'] == 'IN_SERVICE'}">üü¢ In Servizio</option>
                                <option value="ASSIGNED" th:selected="${currentFilters['status'] == 'ASSIGNED'}">üîµ Assegnato</option>
                                <option value="IN_MAINTENANCE" th:selected="${currentFilters['status'] == 'IN_MAINTENANCE'}">üü° In Manutenzione</option>
                                <option value="OUT_OF_SERVICE" th:selected="${currentFilters['status'] == 'OUT_OF_SERVICE'}">üî¥ Fuori Servizio</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="bi bi-truck me-1"></i>
                                Tipo Veicolo
                            </label>
                            <select class="form-select filter-select" name="type" id="typeFilter">
                                <option value="">Tutti i tipi</option>
                                <option value="CAR" th:selected="${currentFilters['type'] == 'CAR'}">üöó Auto</option>
                                <option value="VAN" th:selected="${currentFilters['type'] == 'VAN'}">üöê Furgone</option>
                                <option value="TRUCK" th:selected="${currentFilters['type'] == 'TRUCK'}">üöõ Camion</option>
                                <option value="MOTORCYCLE" th:selected="${currentFilters['type'] == 'MOTORCYCLE'}">üèçÔ∏è Moto</option>
                            </select>
                        </div>
                        
                        <div class="filter-actions">
                            <a href="/fleet/vehicles" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Reset
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>
                                Applica
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Actions Bar (margini ridotti) -->
    <div class="quick-actions-bar" style="margin-bottom: 1.5rem;">
        <div class="actions-left">
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" title="Vista Griglia">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
                <button class="view-btn" data-view="table" title="Vista Tabella">
                    <i class="bi bi-list-ul"></i>
                </button>
            </div>
            <div class="results-info">
                <span class="results-count" id="resultsCount" th:text="${vehicles.size()} + ' veicoli trovati'">0 veicoli trovati</span>
            </div>
        </div>
        
        <div class="actions-right">
            <button class="btn btn-outline-primary" onclick="exportData()">
                <i class="bi bi-download me-1"></i>
                Esporta
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="bi bi-printer me-2"></i>Stampa Lista</a></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-calendar-check me-2"></i>Scadenze</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Impostazioni Vista</a></li>
                </ul>
            </div>
            <a class="btn btn-primary btn-add-vehicle"
               th:href="@{/fleet/vehicles/new}"
               sec:authorize="hasAnyRole('Administrator','Fleet Manager')">
                <i class="bi bi-plus-lg me-1"></i>
                Nuovo Veicolo
            </a>
        </div>
    </div>

    <!-- Grid View -->
    <div class="vehicles-grid-view" id="gridView">
        <!-- Messaggio quando non ci sono veicoli -->
        <div th:if="${vehicles.empty}" class="empty-state">
            <div class="empty-state-content">
                <div class="empty-icon">
                    <i class="bi bi-car-front"></i>
                </div>
                <h3>Nessun veicolo trovato</h3>
                <p>Non ci sono veicoli che corrispondono ai criteri di ricerca selezionati.</p>
                <a href="/fleet/vehicles" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Ripristina Filtri
                </a>
            </div>
        </div>

        <!-- Griglia veicoli ottimizzata -->
        <div class="vehicles-grid" th:unless="${vehicles.empty}">
            <div class="vehicle-card" 
                 th:each="v : ${vehicles}" 
                 th:data-status="${v.status.name()}"
                 th:data-type="${v.type.name()}"
                 th:data-search="${v.plate + ' ' + v.brand + ' ' + v.model + ' ' + (v.chassisNumber ?: '')}">
                
                <!-- Header senza pallini -->
                <div class="vehicle-card-header">
                    <!-- Immagine del veicolo (pi√π grande) -->
                    <div class="vehicle-image-container">
                        <!-- Se esiste un'immagine del veicolo -->
                        <div th:if="${vehicleImages.containsKey(v.id)}">
                            <img th:with="vehicleImage=${vehicleImages[v.id]}"
                                 th:src="@{|/fleet/vehicles/files/${v.id}/${vehicleImage.path.substring(vehicleImage.path.lastIndexOf('/') + 1)}|}"
                                 th:alt="'Foto ' + ${v.plate}" />
                        </div>
                        <!-- Se non esiste un'immagine, mostra icona -->
                        <div th:unless="${vehicleImages.containsKey(v.id)}"
                             class="vehicle-icon-fallback"
                             th:classappend="${v.type.name() == 'CAR'} ? 'icon-car' : 
                                           (${v.type.name() == 'VAN'} ? 'icon-van' : 
                                           (${v.type.name() == 'TRUCK'} ? 'icon-truck' : 'icon-default'))">
                            <i th:class="${v.type.name() == 'CAR'} ? 'bi bi-car-front-fill' : 
                                        (${v.type.name() == 'VAN'} ? 'bi bi-truck' : 
                                        (${v.type.name() == 'TRUCK'} ? 'bi bi-truck-front' : 'bi bi-car-front'))"
                               style="font-size: 3rem; color: white;"></i>
                        </div>
                        
                        <!-- Overlay per tipo veicolo -->
                        <div class="vehicle-type-overlay">
                            <span th:text="${v.type.displayName ?: v.type.name()}">Auto</span>
                        </div>
                    </div>
                </div>

                <div class="vehicle-card-body">
                    <!-- Info veicolo -->
                    <div class="vehicle-info">
                        <h3 class="vehicle-plate" th:text="${v.plate}">TARGA</h3>
                        <div class="vehicle-details">
                            <div class="vehicle-brand" th:text="${v.brand + ' ' + v.model}">MARCA MODELLO</div>
                            <div class="vehicle-year">Anno <span th:text="${v.year}">2020</span></div>
                        </div>
                    </div>

                    <!-- Badge stato -->
                    <div class="vehicle-badges">
                        <span class="vehicle-status-badge" 
                              th:classappend="${v.status.name() == 'IN_SERVICE'} ? 'badge-success' : 
                                            (${v.status.name() == 'ASSIGNED'} ? 'badge-info' :
                                            (${v.status.name() == 'IN_MAINTENANCE'} ? 'badge-warning' : 'badge-danger'))"
                              th:text="${v.status.displayName ?: v.status.name()}">Stato</span>
                    </div>


                    <!-- Meta info -->
                    <div class="vehicle-meta">
                        <div class="meta-item">
                            <i class="bi bi-speedometer2 me-1"></i>
                            <span th:text="${v.currentMileage != null ? v.currentMileage + ' km' : 'N/D'}">N/D km</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-briefcase"></i>
                            <span th:text="${v.ownership.displayName}">N/D</span>
                        </div>
                    </div>
                    <!-- Scadenze Alert -->
                    <div class="vehicle-alerts" th:if="${v.insuranceExpiryDate != null and T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), v.insuranceExpiryDate) <= 30} or 
                                                        ${v.carTaxExpiryDate != null and T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), v.carTaxExpiryDate) <= 30}">
                        <div class="alert-item">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <span>Scadenze imminenti</span>
                        </div>
                    </div>
                </div>

                <!-- Footer con 3 pulsanti -->
                <div class="vehicle-card-footer">
                    <div class="card-actions">
                        <a th:href="@{|/fleet/vehicles/${v.id}|}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye me-1"></i>Dettagli
                        </a>
                         <a th:href="@{|/fleet/vehicles/${v.id}/edit|}"
                           class="btn btn-primary btn-sm"
                           sec:authorize="hasAnyRole('Administrator','Fleet Manager')">
                            <i class="bi bi-pencil me-1"></i>Modifica
                        </a>
                        <button class="btn btn-outline-danger btn-sm"
                                th:data-vehicle-id="${v.id}"
                                th:data-vehicle-plate="${v.plate}"
                                onclick="deleteVehicle(this.dataset.vehicleId, this.dataset.vehiclePlate)"
                                sec:authorize="hasAnyRole('Administrator','Fleet Manager')">
                            <i class="bi bi-trash me-1"></i>Elimina
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table View (Hidden by default) -->
    <div class="vehicles-table-view" id="tableView" style="display: none;">
        <div class="modern-table-card" th:unless="${vehicles.empty}">
            <div class="table-responsive">
                <table class="table vehicles-table" id="vehiclesTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="plate">
                                <div class="th-content">
                                    <span>Veicolo</span>
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable" data-sort="brand">
                                <div class="th-content">
                                    <span>Marca/Modello</span>
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable" data-sort="type">
                                <div class="th-content">
                                    <span>Tipo</span>
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable" data-sort="year">
                                <div class="th-content">
                                    <span>Anno</span>
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </div>
                            </th>
                            <th class="sortable" data-sort="status">
                                <div class="th-content">
                                    <span>Stato</span>
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </div>
                            </th>
                            <th>Scadenze</th>
                            <th class="actions-column">Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-row" th:each="v : ${vehicles}">
                            <td>
                                <div class="vehicle-cell">
                                    <!-- Immagine nella tabella -->
                                    <div class="vehicle-avatar-sm" style="width: 50px; height: 40px; border-radius: 0.375rem; overflow: hidden;">
                                        <!-- Se esiste un'immagine del veicolo -->
                                        <div th:if="${vehicleImages.containsKey(v.id)}">
                                            <img th:with="vehicleImage=${vehicleImages[v.id]}"
                                                 th:src="@{|/fleet/vehicles/files/${v.id}/${vehicleImage.path.substring(vehicleImage.path.lastIndexOf('/') + 1)}|}"
                                                 style="width: 100%; height: 100%; object-fit: cover;"
                                                 th:alt="'Foto ' + ${v.plate}" />
                                        </div>
                                        <!-- Se non esiste un'immagine, mostra icona -->
                                        <div th:unless="${vehicleImages.containsKey(v.id)}"
                                             style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f3f4f6;">
                                            <i th:class="${v.type.name() == 'CAR'} ? 'bi bi-car-front' : 
                                                        (${v.type.name() == 'VAN'} ? 'bi bi-truck' : 
                                                        (${v.type.name() == 'TRUCK'} ? 'bi bi-truck-front' : 'bi bi-car-front'))"
                                               style="color: #6b7280;"></i>
                                        </div>
                                    </div>
                                    <div class="vehicle-info-sm">
                                        <div class="vehicle-plate-sm" th:text="${v.plate}">TARGA</div>
                                        <small class="vehicle-chassis" th:text="${v.chassisNumber ?: 'N/D'}">VIN...</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="brand-info">
                                    <div class="brand-name" th:text="${v.brand}">MARCA</div>
                                    <div class="model-name" th:text="${v.model}">MODELLO</div>
                                </div>
                            </td>
                            <td>
                                <span class="type-badge-sm" th:text="${v.type.displayName ?: v.type.name()}">Auto</span>
                            </td>
                            <td>
                                <span class="year-text" th:text="${v.year}">2020</span>
                            </td>
                            <td>
                                <span class="status-badge-sm" 
                                      th:classappend="${v.status.name() == 'IN_SERVICE'} ? 'status-active' : 
                                                    (${v.status.name() == 'ASSIGNED'} ? 'status-assigned' :
                                                    (${v.status.name() == 'IN_MAINTENANCE'} ? 'status-maintenance' : 'status-inactive'))"
                                      th:text="${v.status.displayName ?: v.status.name()}">Stato</span>
                            </td>
                            <td>
                                <div class="deadlines-cell">
                                    <th:block th:if="${v.insuranceExpiryDate != null and T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), v.insuranceExpiryDate) <= 30}">
                                        <span class="deadline-badge deadline-danger" title="Assicurazione in scadenza">
                                            <i class="bi bi-shield-exclamation"></i>
                                            Assic
                                        </span>
                                    </th:block>
                                    <th:block th:if="${v.carTaxExpiryDate != null and T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), v.carTaxExpiryDate) <= 30}">
                                        <span class="deadline-badge deadline-warning" title="Bollo in scadenza">
                                            <i class="bi bi-receipt"></i>
                                            Bollo
                                        </span>
                                    </th:block>
                                </div>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <a th:href="@{|/fleet/vehicles/${v.id}|}"
                                       class="action-btn action-view" 
                                       title="Visualizza dettagli">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a th:href="@{|/fleet/vehicles/${v.id}/edit|}"
                                       class="action-btn action-edit"
                                       title="Modifica veicolo"
                                       sec:authorize="hasAnyRole('Administrator','Fleet Manager')">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="action-btn action-delete" 
                                            th:data-vehicle-id="${v.id}"
                                            th:data-vehicle-plate="${v.plate}"
                                            onclick="deleteVehicle(this.dataset.vehicleId, this.dataset.vehiclePlate)"
                                            title="Elimina veicolo"
                                            sec:authorize="hasAnyRole('Administrator','Fleet Manager')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                        Conferma Eliminazione
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sei sicuro di voler eliminare il veicolo <strong id="vehicleToDelete"></strong>?</p>
                    <p class="text-muted mb-0">Questa azione non pu√≤ essere annullata e rimuover√† tutti i dati associati.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <form id="deleteForm" method="post" class="d-inline">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-1"></i>
                            Elimina Definitivamente
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modern JavaScript for enhanced functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöó Inizializzazione pagina veicoli...');
            initializeVehiclesPage();
        });

        function initializeVehiclesPage() {
            // View toggle functionality
            setupViewToggle();
            
            // Filter functionality  
            setupFilters();
            
            // Update results count
            updateResultsCount();
            
            console.log('‚úÖ Pagina veicoli inizializzata');
        }

        function setupViewToggle() {
            const viewButtons = document.querySelectorAll('.view-btn');
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');

            viewButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.dataset.view;
                    
                    // Update active button
                    viewButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Toggle views
                    if (view === 'grid') {
                        gridView.style.display = 'block';
                        tableView.style.display = 'none';
                    } else {
                        gridView.style.display = 'none';
                        tableView.style.display = 'block';
                    }
                    
                    console.log('üì± Vista cambiata a:', view);
                });
            });
        }

        function setupFilters() {
            const filterToggle = document.getElementById('filterToggle');
            const filterContent = document.getElementById('filterContent');

            // Filter toggle
            filterToggle?.addEventListener('click', function() {
                const isHidden = filterContent.style.display === 'none';
                filterContent.style.display = isHidden ? 'block' : 'none';
                const icon = this.querySelector('i');
                icon.className = isHidden ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
                
                console.log('üîç Filtri', isHidden ? 'aperti' : 'chiusi');
            });
        }

        function updateResultsCount() {
            const resultsCount = document.getElementById('resultsCount');
            if (resultsCount) {
                console.log('üìä Conteggio risultati aggiornato');
            }
        }

        function deleteVehicle(id, plate) {
            document.getElementById('vehicleToDelete').textContent = plate;
            document.getElementById('deleteForm').action = `/fleet/vehicles/${id}/delete`;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
            
            console.log('üóëÔ∏è Richiesta eliminazione per:', plate);
        }

        function exportData() {
            window.location.href = '/fleet/vehicles/export?format=csv';
            console.log('üì§ Export dati avviato');
        }
    </script>
    </div>
</body>
</html>