<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layoutNavBar :: layout(~{::title}, ~{::body}, ~{::cssblock}, ~{::navbar})}">
<head>
    <title th:text="${vehicle.id == null ? 'Nuovo Veicolo' : 'Modifica Veicolo'}">Veicolo</title>
    <th:block th:fragment="cssblock">
    	<link rel="stylesheet" th:href="@{/css/vehicle-form.css}">
    </th:block>
</head>
<th:block th:fragment="navbar">
</th:block>
<body>
<div class="container-fluid" style="max-width: 1600px;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent p-0 m-0">
                    <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/fleet/vehicles}">Veicoli</a></li>
                    <li class="breadcrumb-item active" aria-current="page" th:text="${vehicle.id == null ? 'Nuovo' : 'Modifica'}"></li>
                </ol>
            </nav>
            <div class="h2 mb-0 fw-bold" th:text="${vehicle.plate != null ? 'Modifica Veicolo' : 'Nuovo Veicolo'}"></div>
        </div>
        <div class="d-flex gap-2 action-button-group">
            <a th:href="@{/fleet/vehicles}" class="btn btn-lg btn-outline-secondary">Annulla</a>
            <button type="submit" form="vehicleDetailsForm" class="btn btn-lg btn-primary">
                <i class="bi bi-check2-circle me-1"></i>
                <span th:text="${vehicle.id == null ? 'Crea e Continua' : 'Salva Modifiche'}"></span>
            </button>
        </div>
    </div>

    <ul class="nav nav-pills flex-nowrap overflow-auto mb-4" id="vehicleTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-details" type="button" role="tab"><i class="bi bi-car-front-fill me-2"></i>Dettagli Veicolo</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-docs" type="button" role="tab" th:disabled="${vehicle.id == null}"><i class="bi bi-folder2-open me-2"></i>Documenti</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-tasks" type="button" role="tab" th:disabled="${vehicle.id == null}"><i class="bi bi-list-check me-2"></i>Task di Manutenzione</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="pane-details" role="tabpanel">
            <form id="vehicleDetailsForm" th:object="${vehicle}" th:action="${vehicle.id == null} ? @{/fleet/vehicles/new} : @{/fleet/vehicles/{id}/edit(id=${vehicle.id})}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-light"><h5 class="mb-0">Foto e Stato</h5></div>
                            <div class="card-body text-center p-4">
                                <img th:if="${vehicleImage != null}" th:src="@{/fleet/vehicles/files/{id}/{fn}(id=${vehicle.id},fn=${vehicleImage.path.substring(vehicleImage.path.lastIndexOf('/') + 1)})}" class="rounded shadow-sm mb-3" style="width: 100%; height: 250px; object-fit: cover;" alt="Foto veicolo" />
                                <div th:if="${vehicleImage == null}" class="border rounded d-flex align-items-center justify-content-center bg-light mb-3" style="width: 100%; height: 200px;"><i class="bi bi-truck-front fs-1 text-secondary"></i></div>
                                <div class="row">
                                	<div class="col-md-6">
                                		 <label class="form-label">Targa</label> 
										<input class="form-control" th:field="*{plate}" required />
                                	</div>
	                                <div class="col-md-6">
											<label class="form-label">Stato</label> 
											<select	class="form-select" th:field="*{status}">
												<option th:each="s : ${T(com.veely.model.VehicleStatus).values()}" th:value="${s}" th:text="${s.displayName}"></option>
											</select>
									</div>
								</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light"><h5 class="mb-0">Informazioni Veicolo</h5></div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-md-6"><label class="form-label">Marca</label><input class="form-control" th:field="*{brand}" /></div>
                                    <div class="col-md-6"><label class="form-label">Modello</label><input class="form-control" th:field="*{model}" /></div>
                                    <div class="col-12"><label class="form-label">Allestimento</label><input class="form-control" th:field="*{series}" /></div>
                                    <hr class="my-2">
                                    <div class="col-md-6"><label class="form-label">Telaio (VIN)</label><input class="form-control" th:field="*{chassisNumber}" /></div>
                                    <div class="col-md-6"><label class="form-label">Immatricolazione</label><input type="date" class="form-control" th:field="*{registrationDate}" /></div>
                                    <div class="col-md-4"><label class="form-label">Tipo Veicolo</label><select class="form-select" th:field="*{type}"><option th:each="t : ${T(com.veely.model.VehicleType).values()}" th:value="${t}" th:text="${t.displayName}"></option></select></div>
                                    <div class="col-md-4"><label class="form-label">Carburante</label><select class="form-select" th:field="*{fuelType}"><option th:each="f : ${T(com.veely.model.FuelType).values()}" th:value="${f}" th:text="${f.displayName}"></option></select></div>
                                    <div class="col-md-4"><label class="form-label">Anno</label><input type="number" class="form-control" th:field="*{year}" /></div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-12">
                         <div class="card shadow-sm">
                             <div class="card-header bg-light"><h5 class="mb-0">Dati Amministrativi</h5></div>
                             <div class="card-body p-4">
                                 <div class="row g-3">
                                     <div class="col-md-3"><label class="form-label">Proprietà</label><select class="form-select" th:field="*{ownership}" id="ownershipSelect"><option th:each="o : ${ownershipTypes}" th:value="${o}" th:text="${o.displayName}"></option></select></div>
                                     <div class="col-md-3"><label class="form-label">Chilometri</label><div class="input-group"><input type="number" class="form-control" th:field="*{currentMileage}" /><span class="input-group-text">km</span></div></div>
                                     <div class="col-md-3"><label class="form-label">Scad. Assicurazione</label><input type="date" class="form-control" th:field="*{insuranceExpiryDate}" /></div>
                                     <div class="col-md-3"><label class="form-label">Scad. Bollo</label><input type="date" class="form-control" th:field="*{carTaxExpiryDate}" /></div>
                                     <div class="col-md-4"><label class="form-label">Telepass</label><input class="form-control" th:field="*{telepass}" /></div>
                                     <div class="col-md-4"><label class="form-label">Fuel Card</label><select class="form-select" th:field="*{fuelCard.id}"><option value="">-</option><option th:each="fc : ${fuelCards}" th:value="${fc.id}" th:text="${fc.cardNumber}"></option></select></div>
                                 </div>
                                 <div class="pt-3 d-none" id="leasingDetailsWrapper">
                                     <hr><h6 class="text-primary fw-bold mb-3">Dettagli Leasing</h6>
                                     <div class="row g-3">
                                         <div class="col-md-8"><label class="form-label">Fornitore</label><select class="form-select" th:field="*{supplier}"><option th:each="s : ${suppliers}" th:value="${s.id}" th:text="${s.name}"></option></select></div>
                                         <div class="col-md-4"><label class="form-label">Durata (mesi)</label><input type="number" class="form-control" th:field="*{contractDuration}" /></div>
                                         <div class="col-md-6"><label class="form-label">Inizio Contratto</label><input type="date" class="form-control" th:field="*{contractStartDate}" /></div>
                                         <div class="col-md-6"><label class="form-label">Fine Contratto</label><input type="date" class="form-control" th:field="*{contractEndDate}" /></div>
                                         <div class="col-md-3"><label class="form-label">Km Contratto</label><input type="number" class="form-control" th:field="*{contractualKm}" /></div>
                                         <div class="col-md-3"><label class="form-label">Canone Finanziario</label><div class="input-group"><input type="number" step="0.01" class="form-control" th:field="*{financialFee}" /><span class="input-group-text">€</span></div></div>
                                         <div class="col-md-3"><label class="form-label">Canone Assistenza</label><div class="input-group"><input type="number" step="0.01" class="form-control" th:field="*{assistanceFee}" /><span class="input-group-text">€</span></div></div>
                                         <div class="col-md-3"><label class="form-label">Canone Totale</label><div class="input-group"><input type="number" step="0.01" class="form-control" th:field="*{totalFee}" /><span class="input-group-text">€</span></div></div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="pane-docs" role="tabpanel">
             <div th:if="${vehicle.id != null}" class="card shadow-sm">
                <div class="card-header bg-light"><h5 class="mb-0 fw-semibold">Gestione Documenti</h5></div>
                <div class="card-body p-4">
                    <form class="row g-3 mb-4 p-3 border rounded bg-light" th:action="@{/fleet/vehicles/{id}/docs(id=${vehicle.id})}" method="post" enctype="multipart/form-data">
                         <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="col-md-4"><input type="file" name="file" class="form-control-file" id="document" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.webp" required /></div>
                        <div class="col-md-2"><select name="type" class="form-select"><option th:each="dt : ${docTypes}" th:value="${dt}" th:text="${dt.displayName}"></option></select></div>
                        <div class="col-md-2"><input type="date" name="issueDate" class="form-control" title="Data Emissione" th:value="${#temporals.format(T(java.time.LocalDate).now(), 'yyyy-MM-dd')}" /></div>
                        <div class="col-md-2"><input type="date" name="expiryDate" class="form-control" title="Data Scadenza" /></div>
                        <div class="col-md-2 d-grid"><button type="submit" class="btn btn-success"><i class="bi bi-upload me-1"></i>Carica</button></div>
                    </form>
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>Tipo</th><th>File</th><th>Emesso</th><th>Scadenza</th><th class="text-center">Azioni</th></tr></thead>
                        <tbody>
                             <tr th:each="doc : ${documents}">
                                <td th:text="${doc.type.displayName}"></td>
                                <td th:text="${doc.path.substring(doc.path.lastIndexOf('/')+1)}"></td>
                                <td th:text="${doc.issueDate} ? ${#temporals.format(doc.issueDate, 'dd/MM/yyyy')} : '-'"></td>
                                <td th:text="${doc.expiryDate} ? ${#temporals.format(doc.expiryDate, 'dd/MM/yyyy')} : '-'"></td>
                                <td class="text-center action-button-group">
                                    <a th:href="@{/fleet/vehicles/files/{vehId}/{fn}(vehId=${vehicle.id},fn=${doc.path.substring(doc.path.lastIndexOf('/')+1)})}" class="btn btn-sm btn-outline-primary" title="Download"><i class="bi bi-download"></i></a>
                                    <a th:href="@{/fleet/vehicles/{vehId}/docs/{docId}/delete(vehId=${vehicle.id},docId=${doc.id})}" class="btn btn-sm btn-outline-danger" title="Elimina" onclick="return confirm('Eliminare il documento?');"><i class="bi bi-trash"></i></a>
                                </td>
                             </tr>
                            <tr th:if="${#lists.isEmpty(documents)}"><td colspan="5" class="text-center text-muted py-4">Nessun documento presente.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pane-tasks" role="tabpanel">
            <div th:if="${vehicle.id != null}" class="card shadow-sm">
                 <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold">Task di Manutenzione</h5>
                    <a th:href="@{/fleet/tasks/vehicle/{id}/new(id=${vehicle.id})}" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg me-1"></i>Aggiungi Task</a>
                 </div>
                <div class="card-body p-4">
                	<form th:action="@{/fleet/tasks/vehicle/{id}/auto(id=${vehicle.id})}" method="post" class="row g-3 mb-4">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="col-12">
                            <label class="form-label fw-semibold">Task automatici da gestire</label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check" th:each="t : ${autoTypes}">
                                    <input class="form-check-input" type="checkbox" name="typeIds"
                                           th:id="'auto-' + ${t.id}" th:value="${t.id}"
                                           th:checked="${activeAutoIds.contains(t.id)}" />
                                    <label class="form-check-label" th:for="'auto-' + ${t.id}" th:text="${t.description}"></label>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-check-lg me-1"></i>Aggiorna</button>
                        </div>
                    </form>
                    <table class="table table-hover align-middle">
                       <!--  <thead class="table-light"><tr><th>Tipo</th><th>Data Scadenza</th><th>Scadenza Km</th><th class="text-center">Azioni</th></tr></thead> -->
                       <thead class="table-light"><tr><th>Tipo</th><th>Data Scadenza</th><th>Scadenza Km</th><th>Eseguito</th><th class="text-center">Azioni</th></tr></thead>
                        <tbody>
                            <tr th:each="t : ${tasks}">
                                <td th:text="${t.type?.description ?: '-'}"></td>
                                <td th:text="${t.dueDate!=null? #temporals.format(t.dueDate,'dd/MM/yyyy') : '-'}"></td>
                                <td th:text="${t.dueMileage!=null? t.dueMileage : '-'}"></td>
                                 <td th:text="${t.executed ? 'Si' : 'No'}"></td>
                                <td class="text-center action-button-group">
                                    <a th:href="@{/fleet/maintenance/new(taskId=${t.id})}" class="btn btn-sm btn-outline-success" title="Registra Manutenzione"><i class="bi bi-wrench-adjustable"></i></a>
                                    <a th:href="@{/fleet/tasks/{id}/edit(id=${t.id})}" class="btn btn-sm btn-outline-primary" title="Modifica"><i class="bi bi-pencil"></i></a>
                                    <form th:action="@{/fleet/tasks/{id}/delete(id=${t.id})}" method="post" class="d-inline">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /><input type="hidden" name="vehicleId" th:value="${vehicle.id}" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sei sicuro?');" title="Elimina"><i class="bi bi-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(tasks)}"><td colspan="4" class="text-center text-muted py-4">Nessun task pianificato.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/js/file-validation.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ownershipSelect = document.getElementById('ownershipSelect');
        const leasingWrapper = document.getElementById('leasingDetailsWrapper');
        
        const toggleLeasingView = () => {
          if (!ownershipSelect || !leasingWrapper) return;
          const show = ownershipSelect.value === 'LEASED';
          leasingWrapper.classList.toggle('d-none', !show);
        };
        
        toggleLeasingView();
        ownershipSelect?.addEventListener('change', toggleLeasingView);
    });
</script>
</body>
</html>