<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layoutNavBar :: layout(~{::title}, ~{::body}, ~{::cssblock}, ~{::navbar})}">
<head>
  <title>Dettaglio Veicolo – Veely</title>
  <th:block th:fragment="cssblock">
    <link rel="stylesheet" th:href="@{/css/vehicle-detail.css}">
  </th:block>
</head>
<th:block th:fragment="navbar">
</th:block>
<body>
<main class="page-content">
    <!-- Messages -->
    <div th:if="${successMessage}" class="container">
        <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${successMessage}"></span>
        </div>
    </div>
    <div th:if="${errorMessage}" class="container">
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
        </div>
    </div>

    <!-- Hero -->
    <div class="hero-section rounded-4">
        <div class="container">
            <i class="bi bi-car-front display-6 fw-bold mb-2"></i><span class="display-6 fw-bold mb-2" th:text="' ' + ${vehicle.brand} + ' ' + ${vehicle.model} + ' ' + ${vehicle.series}">PEUGEOT 308 SW</span>
            <p class="lead mb-0" th:text="${vehicle.plate}">GT138PR</p>
        </div>
    </div>

    <div class="container-xl vehicle-detail-container py-4">
        <!-- Employee -->
        <div th:if="${assignedEmployee != null}" class="assigned-employee">
            <div class="employee-avatar" th:text="${#strings.substring(assignedEmployee.firstName,0,1) + #strings.substring(assignedEmployee.lastName,0,1)}">NA</div>
            <div>
                <h6 class="mb-1 fw-bold">Assegnato a <span th:text="${assignedEmployee.firstName + ' ' + assignedEmployee.lastName}">Nome</span></h6>
                <small class="text-muted">Dipendente attivo</small>
            </div>
        </div>

        <!-- Vehicle Card -->
        <div class="vehicle-hero-card">
            <div class="row g-0">
                <div class="col-12 col-md-6">
                    <div class="vehicle-image-container">
                        <img th:if="${vehicleImage != null}"
                             th:src="@{/fleet/vehicles/files/{id}/{fn}(id=${vehicle.id},fn=${vehicleImage.path.substring(vehicleImage.path.lastIndexOf('/')+1)})}"
                             class="vehicle-image" th:alt="'Foto ' + ${vehicle.brand}"/>
                        <div th:if="${vehicleImage == null}" class="vehicle-placeholder">
                            <i class="bi bi-truck-front display-1"></i>
                        </div>
                        <div class="vehicle-status-badge d-none d-md-block"
                             th:classappend="${vehicle.status.name() == 'IN_SERVICE' ? 'status-in-service' : 
                                           vehicle.status.name() == 'ASSIGNED' ? 'status-assigned' : 
                                           vehicle.status.name() == 'MAINTENANCE' ? 'status-maintenance' : 'status-unavailable'}">
                            <i class="bi bi-check-circle me-1" th:if="${vehicle.status.name() == 'IN_SERVICE'}"></i>
                            <i class="bi bi-person-fill me-1" th:if="${vehicle.status.name() == 'ASSIGNED'}"></i>
                            <i class="bi bi-wrench-adjustable me-1" th:if="${vehicle.status.name() == 'MAINTENANCE'}"></i>
                            <i class="bi bi-x-circle me-1" th:if="${vehicle.status.name() == 'UNAVAILABLE'}"></i>
                            <span th:text="${vehicle.status.displayName}">In Servizio</span>
                        </div>
                    </div>
                    <div class="d-block d-md-none p-3">
                        <div class="vehicle-status-badge"
                             th:classappend="${vehicle.status.name() == 'IN_SERVICE' ? 'status-in-service' : 'status-assigned'}">
                            <i class="bi bi-check-circle me-1"></i>
                            <span th:text="${vehicle.status.displayName}">In Servizio</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="vehicle-info-grid">
                        <div class="info-item">
                            <div class="info-icon"><i class="bi bi-calendar"></i></div>
                            <div class="info-content">
                                <p class="info-label">Immatricolazione</p>
                                <p class="info-value" th:text="${vehicle.registrationDate != null ? #temporals.format(vehicle.registrationDate,'dd/MM/yyyy') : 'N/D'}">15/03/2024</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon"><i class="bi bi-fuel-pump"></i></div>
                            <div class="info-content">
                                <p class="info-label">Carburante</p>
                                <p class="info-value" th:text="${vehicle.fuelType?.displayName ?: 'N/D'}">Diesel</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon"><i class="bi bi-clipboard-check"></i></div>
                            <div class="info-content">
                                <p class="info-label">Km Contratto</p>
                                <p class="info-value" th:text="${#numbers.formatInteger(vehicle.contractualKm != null ? vehicle.contractualKm : 0, 0, 'COMMA')}">120,000</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon"><i class="bi bi-speedometer2"></i></div>
                            <div class="info-content">
                                <p class="info-label">Km Attuali</p>
                                <p class="info-value" th:text="${#numbers.formatInteger(vehicle.currentMileage != null ? vehicle.currentMileage : 0, 0, 'COMMA')}">27,000</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon"><i class="bi bi-router"></i></div>
                            <div class="info-content">
                                <p class="info-label">Telepass</p>
                                <p class="info-value" th:text="${vehicle.telepass ?: 'N/D'}">N/D</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon"><i class="bi bi-shield-check"></i></div>
                            <div class="info-content">
                                <p class="info-label">Scad. Assicurazione</p>
                                <span class="expiry-badge"
                                      th:classappend="${vehicle.insuranceExpiryDate != null ? 
                                         (T(java.time.temporal.ChronoUnit).DAYS.between(#temporals.createNow().toLocalDate(), vehicle.insuranceExpiryDate) <= 30 ? 'expiry-danger' : 
                                          T(java.time.temporal.ChronoUnit).DAYS.between(#temporals.createNow().toLocalDate(), vehicle.insuranceExpiryDate) <= 90 ? 'expiry-warning' : 'expiry-ok') : 'expiry-danger'}"
                                      th:text="${vehicle.insuranceExpiryDate != null ? #temporals.format(vehicle.insuranceExpiryDate,'dd/MM/yyyy') : 'N/D'}">18/09/2025</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mileage - Fixed Form -->
        <div class="mileage-section">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-speedometer2 me-2"></i>
                Gestione Chilometraggio
            </h5>
            <div class="mileage-update-form">
                <form th:action="@{|/fleet/vehicles/${vehicle.id}/mileage|}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="mileage-form-container">
                        <div class="mileage-input-group">
                            <label class="form-label">Aggiorna Chilometraggio</label>
                            <input type="number" name="newMileage" class="form-control" 
                                   placeholder="Inserisci nuovi km" 
                                   th:min="${vehicle.currentMileage}" 
                                   required>
                            <small class="text-muted">
                                Ultimo aggiornamento: 
                                <span th:text="${#numbers.formatInteger(vehicle.currentMileage != null ? vehicle.currentMileage : 0, 0, 'COMMA')}">27,000</span> km
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary-modern mileage-submit-btn">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            <span class="d-none d-sm-inline">Aggiorna</span>
                            <span class="d-inline d-sm-none">OK</span>
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="progress-container">
                <div class="progress-label">
                    <span>Utilizzo Contrattuale</span>
                    <span class="fw-bold" th:text="${vehicle.contractualKm != null && vehicle.contractualKm > 0 && vehicle.currentMileage != null ? (vehicle.currentMileage*100/vehicle.contractualKm).intValue() + '%' : '0%'}">22%</span>
                </div>
                <div class="modern-progress">
                    <div class="progress-bar-animated" 
                         th:style="${vehicle.contractualKm != null && vehicle.contractualKm > 0 && vehicle.currentMileage != null ? 'width:' + (vehicle.currentMileage*100/vehicle.contractualKm).intValue() + '%;' : 'width:0%;'}"></div>
                </div>
                <div class="progress-info">
                    <span th:text="${vehicle.contractualKm != null && vehicle.currentMileage != null ? #numbers.formatInteger(vehicle.contractualKm - vehicle.currentMileage, 0, 'COMMA') : '0'}">93,000</span> 
                    km rimanenti su 
                    <span th:text="${#numbers.formatInteger(vehicle.contractualKm != null ? vehicle.contractualKm : 0, 0, 'COMMA')}">120,000</span> 
                    km totali
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="#" class="quick-action-card">
                <i class="bi bi-fuel-pump-fill display-6 text-primary mb-2 d-none d-md-block"></i>
                <i class="bi bi-fuel-pump-fill fs-1 text-primary mb-2 d-block d-md-none"></i>
                <h6 class="fw-bold">Rifornimento</h6>
                <small class="text-muted d-none d-md-block">Registra rifornimento</small>
            </a>
            <a th:href="@{/fleet/maintenance/new(vehicleId=${vehicle.id})}" class="quick-action-card">
                <i class="bi bi-wrench-adjustable display-6 text-warning mb-2 d-none d-md-block"></i>
                <i class="bi bi-wrench-adjustable fs-1 text-warning mb-2 d-block d-md-none"></i>
                <h6 class="fw-bold">Manutenzione</h6>
                <small class="text-muted d-none d-md-block">Registra manutenzione</small>
            </a>
            <a href="#documenti" class="quick-action-card">
                <i class="bi bi-camera-fill display-6 text-success mb-2 d-none d-md-block"></i>
                <i class="bi bi-camera-fill fs-1 text-success mb-2 d-block d-md-none"></i>
                <h6 class="fw-bold">Documenti</h6>
                <small class="text-muted d-none d-md-block">Carica documenti</small>
            </a>
        </div>

        <!-- Documents -->
        <div class="section-card" id="documenti">
            <div class="section-header">
                <div class="section-icon"><i class="bi bi-folder-fill"></i></div>
                <div>
                    <h5 class="mb-0 fw-bold">Documenti Veicolo</h5>
                    <small class="opacity-75">Gestisci i documenti del tuo veicolo</small>
                </div>
            </div>
            <div class="p-3 p-md-4">
                <div class="upload-zone">
                    <div class="upload-icon"><i class="bi bi-cloud-arrow-up"></i></div>
                    <h6 class="fw-bold mb-2">Carica un nuovo documento</h6>
                    <p class="text-muted mb-3 d-none d-md-block">Trascina i file qui o compila il modulo</p>
                    <p class="text-muted mb-3 d-block d-md-none">Compila il modulo per caricare</p>
                    
                    <form class="row g-3" th:action="@{|/fleet/vehicles/${vehicle.id}/det|}" method="post" enctype="multipart/form-data">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <div class="col-12 col-md-3">
                            <label class="form-label small">File</label>
                            <input type="file" name="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.webp" required>
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label small">Tipo</label>
                            <select name="type" class="form-select" required>
                                <option th:each="dt : ${docTypes}" th:value="${dt}" th:text="${dt.displayName}"></option>
                            </select>
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small">Emissione</label>
                            <input type="date" name="issueDate" class="form-control">
                        </div>
                        <div class="col-6 col-md-2">
                            <label class="form-label small">Scadenza</label>
                            <input type="date" name="expiryDate" class="form-control">
                        </div>
                        <div class="col-12 col-md-2">
                            <label class="form-label small d-block d-md-none">&nbsp;</label>
                            <button type="submit" class="btn btn-primary-modern w-100">
                                <i class="bi bi-upload me-1"></i>Carica
                            </button>
                        </div>
                    </form>
                </div>

                <div class="documents-list">
                    <div th:each="d : ${documents}" class="file-item">
                        <div class="file-icon">
                            <i class="bi bi-file-earmark-pdf" th:if="${#strings.endsWith(d.path, '.pdf')}"></i>
                            <i class="bi bi-file-earmark-image" th:if="${#strings.endsWith(d.path, '.jpg') or #strings.endsWith(d.path, '.jpeg') or #strings.endsWith(d.path, '.png') or #strings.endsWith(d.path, '.webp')}"></i>
                            <i class="bi bi-file-earmark-text" th:unless="${#strings.endsWith(d.path, '.pdf') or #strings.endsWith(d.path, '.jpg') or #strings.endsWith(d.path, '.jpeg') or #strings.endsWith(d.path, '.png') or #strings.endsWith(d.path, '.webp')}"></i>
                        </div>
                        <div class="file-info">
                            <p class="file-name" th:text="${d.type.displayName}">Libretto</p>
                            <p class="file-type" th:text="${d.path.substring(d.path.lastIndexOf('/')+1)}">file.pdf</p>
                            <small th:if="${d.expiryDate != null}" class="text-muted">
                                Scade: <span th:text="${#temporals.format(d.expiryDate,'dd/MM/yyyy')}"></span>
                            </small>
                        </div>
                        <div class="action-buttons">
                            <a th:href="@{|/fleet/vehicles/files/${vehicle.id}/${d.path.substring(d.path.lastIndexOf('/')+1)}|}" 
                               class="btn-modern btn-success-modern" target="_blank">
                                <i class="bi bi-download"></i>
                                <span class="d-none d-md-inline">Scarica</span>
                            </a>
                            <a th:href="@{|/fleet/vehicles/${vehicle.id}/docs/${d.id}/delete|}" 
                               class="btn-modern btn-danger-modern"
                               onclick="return confirm('Eliminare documento?')">
                                <i class="bi bi-trash"></i>
                                <span class="d-none d-md-inline">Elimina</span>
                            </a>
                        </div>
                    </div>
                    
                    <div th:if="${#lists.isEmpty(documents)}" class="text-center py-4">
                        <i class="bi bi-folder2-open display-4 text-muted mb-3 d-none d-md-block"></i>
                        <i class="bi bi-folder2-open fs-1 text-muted mb-3 d-block d-md-none"></i>
                        <p class="text-muted">Nessun documento</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon"><i class="bi bi-list-task"></i></div>
                <div>
                    <h5 class="mb-0 fw-bold">Attività e Scadenze</h5>
                    <small class="opacity-75">Task programmati</small>
                </div>
            </div>
            <div class="p-3 p-md-4">
                <div th:each="t : ${tasks}" class="task-item">
                    <div class="task-info">
                        <div class="task-icon"><i class="bi bi-wrench-adjustable"></i></div>
                        <div>
                            <h6 class="fw-bold mb-1" th:text="${t.type != null ? t.type.description : 'Task'}">Revisione</h6>
                            <p class="text-muted mb-0 small">
                                <span th:if="${t.dueDate != null}">
                                    Scadenza: <span th:text="${#temporals.format(t.dueDate,'dd/MM/yyyy')}"></span>
                                </span>
                                <span th:if="${t.dueMileage != null}">
                                    <span th:if="${t.dueDate != null}"> - </span>
                                    Km: <span th:text="${#numbers.formatInteger(t.dueMileage, 0, 'COMMA')}"></span>
                                </span>
                            </p>
                        </div>
                    </div>
                    <a th:href="@{/fleet/maintenance/new(taskId=${t.id})}" class="btn-modern btn-primary-modern">
                        <i class="bi bi-wrench-adjustable me-1"></i>
                        <span class="d-none d-md-inline">Registra</span>
                    </a>
                </div>

                <div th:if="${#lists.isEmpty(tasks)}" class="text-center py-4">
                    <i class="bi bi-check-circle display-4 text-success mb-3 d-none d-md-block"></i>
                    <i class="bi bi-check-circle fs-1 text-success mb-3 d-block d-md-none"></i>
                    <p class="text-muted">Nessun task programmato</p>
                </div>
            </div>
        </div>

        <!-- Details -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon"><i class="bi bi-info-circle"></i></div>
                <div>
                    <h5 class="mb-0 fw-bold">Informazioni Dettagliate</h5>
                    <small class="opacity-75">Dati tecnici e contrattuali</small>
                </div>
            </div>
            <div class="p-3 p-md-4">
                <div class="row g-3 g-md-4">
                    <div class="col-12 col-md-6">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-car-front me-2"></i>Dati Tecnici
                        </h6>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted small">Telaio:</span>
                            <span class="small" th:text="${vehicle.chassisNumber ?: 'N/D'}">N/D</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted small">Anno:</span>
                            <span class="small" th:text="${vehicle.year}">2024</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted small">Tipo:</span>
                            <span class="small" th:text="${vehicle.type?.displayName ?: 'N/D'}">Auto</span>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span class="text-muted small">Proprietà:</span>
                            <span class="small" th:text="${vehicle.ownership?.displayName ?: 'N/D'}">Leasing</span>
                        </div>
                    </div>
                    
                    <div class="col-12 col-md-6">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="bi bi-file-text me-2"></i>Dati Contrattuali
                        </h6>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted small">Inizio:</span>
                            <span class="small" th:text="${vehicle.contractStartDate != null ? #temporals.format(vehicle.contractStartDate,'dd/MM/yyyy') : 'N/D'}">N/D</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted small">Fine:</span>
                            <span class="small" th:text="${vehicle.contractEndDate != null ? #temporals.format(vehicle.contractEndDate,'dd/MM/yyyy') : 'N/D'}">N/D</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted small">Durata:</span>
                            <span class="small" th:text="${vehicle.contractDuration != null ? vehicle.contractDuration + ' mesi' : 'N/D'}">N/D</span>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span class="text-muted small">Canone:</span>
                            <span class="small" th:text="${vehicle.totalFee != null ? '€ ' + #numbers.formatDecimal(vehicle.totalFee, 0, 2) : 'N/D'}">N/D</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <a th:href="@{/fleet/vehicles}" class="floating-back-btn">
        <i class="bi bi-arrow-left me-2"></i>
        <span class="d-none d-md-inline">Torna alla lista</span>
        <span class="d-inline d-md-none">Indietro</span>
    </a>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isMobile = window.innerWidth < 768;
            
            // File upload feedback
            const fileInput = document.querySelector('input[type="file"]');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        const uploadIcon = document.querySelector('.upload-icon i');
                        const uploadTitle = document.querySelector('.upload-zone h6');
                        uploadIcon.className = 'bi bi-file-check-fill';
                        uploadTitle.textContent = `File: ${this.files[0].name}`;
                        this.closest('.upload-zone').style.borderColor = 'var(--success-color)';
                        this.closest('.upload-zone').style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                    }
                });
            }
            
            // Form loading states
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function() {
                    const btn = this.querySelector('button[type="submit"]');
                    if (btn) {
                        const original = btn.innerHTML;
                        btn.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Caricamento...';
                        btn.disabled = true;
                        setTimeout(() => {
                            btn.innerHTML = original;
                            btn.disabled = false;
                        }, 3000);
                    }
                });
            });
            
            // Progress bar animation with better visibility
            const progressBar = document.querySelector('.progress-bar-animated');
            if (progressBar) {
                const targetWidth = progressBar.style.width;
                progressBar.style.width = '0%';
                setTimeout(() => {
                    progressBar.style.width = targetWidth;
                }, isMobile ? 1000 : 500);
            }
            
            // Smooth scroll for quick actions
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Auto-hide alerts
            document.querySelectorAll('.alert').forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-20px)';
                    setTimeout(() => alert.remove(), 300);
                }, 4000);
            });
            
            // Mileage input validation
            const mileageInput = document.querySelector('input[name="newMileage"]');
            if (mileageInput) {
                mileageInput.addEventListener('input', function() {
                    const currentMileage = parseInt(this.getAttribute('min'));
                    const newMileage = parseInt(this.value);
                    
                    if (newMileage && newMileage < currentMileage) {
                        this.setCustomValidity(`Minimo ${currentMileage.toLocaleString()} km`);
                        this.style.borderColor = 'var(--danger-color)';
                        
                        // Show error message
                        let errorMsg = this.parentNode.querySelector('.error-message');
                        if (!errorMsg) {
                            errorMsg = document.createElement('small');
                            errorMsg.className = 'text-danger error-message d-block mt-1';
                            this.parentNode.appendChild(errorMsg);
                        }
                        errorMsg.textContent = `Il chilometraggio deve essere almeno ${currentMileage.toLocaleString()} km`;
                    } else {
                        this.setCustomValidity('');
                        this.style.borderColor = '';
                        
                        const errorMsg = this.parentNode.querySelector('.error-message');
                        if (errorMsg) {
                            errorMsg.remove();
                        }
                    }
                });
            }
        });
    </script>
</main>
</body>
</html>