<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it"
      th:replace="~{fragments/layoutNavBar :: layout(~{::title}, ~{::body}, ~{::cssblock}, ~{::navbar})}">
<head>
    <title th:text="${employment.id == null ? 'Nuovo Rapporto di Lavoro' : 'Modifica Rapporto'}">Rapporto</title>
	<th:block th:fragment="cssblock">
    	<link rel="stylesheet" th:href="@{/css/employement-form.css}">
    	<style>
			.navbar-enhanced {
				border-left: 4px solid var(--bs-primary);
				transition: all 0.2s ease-in-out;
			}
			
			.navbar-enhanced:hover {
				border-left-width: 8px;
				box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1) !important;
			}
			
			.breadcrumb-item a:hover {
				background: var(--bs-primary-bg-subtle);
				color: var(--bs-primary);
				border-radius: 0.375rem;
				padding: 0.25rem 0.5rem;
			}
		</style>
    </th:block>
</head>

<th:block th:fragment="navbar">

	<div
		class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">

		<nav aria-label="breadcrumb" class="flex-grow-1">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item"><a th:href="@{/}"
					class="text-decoration-none d-flex align-items-center gap-2"> <i
						class="bi bi-house"></i> <span>Home</span>
				</a></li>
				<li class="breadcrumb-item"><a th:href="${returnQuery != null and !returnQuery.isEmpty()} ? @{|/fleet/employments${returnQuery}|} : @{/fleet/employments}"
					class="text-decoration-none">Contratti</a></li>
				<li class="breadcrumb-item active" aria-current="page"
					th:text="${employment.id == null ? 'Nuovo Rapporto di Lavoro' : 'Modifica Rapporto'}">Modifica Rapporto</li>
			</ol>
		</nav>
	</div>

	<div>
            <a th:href="${returnQuery != null and !returnQuery.isEmpty()} ? @{|/fleet/employments${returnQuery}|} : @{/fleet/employments}"
                    class="btn btn-outline-secondary d-flex align-items-center gap-2 flex-shrink-0">
                    <i class="bi bi-list-ul"></i> <span>Torna alla Lista</span>
            </a>
        </div>
</th:block>

<body class="modern-app">
	<div class="modern-form-container">
        <div class="container" style="max-width: 1200px; margin: 0 auto;">
            <!-- Progress Indicator -->
            <div class="form-progress-container" data-aos="fade-up" data-aos-delay="100">
                <div class="step-indicator">
                    <div class="step-item active">
                        <div class="step-number">1</div>
                        <span>Dettagli</span>
                    </div>
                    <div class="step-connector" th:classappend="${employment.id != null} ? 'active' : ''"></div>
                    <div class="step-item" th:classappend="${employment.id != null} ? 'completed' : ''">
                        <div class="step-number">
                            <i th:class="${employment.id != null} ? 'bi bi-check' : '2'"></i>
                        </div>
                        <span>Documenti</span>
                    </div>
                </div>
                <div class="progress-bar-modern">
                    <div class="progress-fill" th:style="${employment.id == null} ? 'width: 50%' : 'width: 100%'"></div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="modern-tab-nav" data-aos="fade-up" data-aos-delay="200">
                <button class="modern-tab-btn active" data-tab="details">
                    <i class="bi bi-info-circle"></i>
                    Dettagli Rapporto
                </button>
                <button class="modern-tab-btn" data-tab="docs" th:disabled="${employment.id == null}">
                    <i class="bi bi-folder2-open"></i>
                    Documenti
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Details Tab -->
                <div class="tab-pane active" id="details-tab">
                    <form id="employment-form" th:object="${employment}"
                          th:action="${employment.id == null} ? @{/fleet/employments/new} : @{/fleet/employments/{id}/edit(id=${employment.id})}"
                          method="post" enctype="multipart/form-data">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="originPage" th:value="${param.originPage}" />
                        <input type="hidden" name="originKeyword" th:value="${param.originKeyword}" />
                        <input type="hidden" name="originStatus" th:value="${param.originStatus}" />
                        <input type="hidden" name="originProject" th:value="${param.originProject}" />
                        <input type="hidden" name="originSort" th:value="${param.originSort}" />
                        <input type="hidden" name="originDir" th:value="${param.originDir}" />

                        <!-- Employee Section -->
                        <div class="form-section" data-aos="fade-up" data-aos-delay="100">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <h3 class="section-title">Dati Dipendente</h3>
                            </div>
                            <div class="section-body">
                                <div class="form-grid form-grid-4">
                                    <div class="form-group">
                                        <label class="form-label">Matricola</label>
                                        <input class="form-input" th:field="*{matricola}" th:disabled="${employment.id != null}" required />
                                    </div>
                                    <div class="form-group" style="grid-column: span 3;">
                                        <label class="form-label">Dipendente</label>
                                        <select id="employeeSelect" class="form-select" th:field="*{employee.id}" th:disabled="${employment.id != null}">
                                            <option th:each="e : ${employees}" th:value="${e.id}" th:text="${e.firstName + ' ' + e.lastName}" th:data-birthdate="${e.birthDate}" th:data-gender="${e.gender}"></option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="employee-info-card" id="employeeInfoCard" style="display: none;">
                                    <div class="employee-details">
                                        <div class="employee-avatar" id="employeeAvatar">ðŸ‘¤</div>
                                        <div class="employee-info">
                                            <div class="employee-name" id="employeeName">Nome Dipendente</div>
                                            <div class="employee-meta">
                                                <span id="employeeAge">EtÃ : N/D</span>
                                                <span id="employeeGender">Sesso: N/D</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contract Details -->
                        <div class="form-section" data-aos="fade-up" data-aos-delay="200">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                                <h3 class="section-title">Dettagli Contratto</h3>
                            </div>
                            <div class="section-body">
                                <div class="form-grid form-grid-3">
                                    <div class="form-group">
                                        <label class="form-label">Data inizio</label>
                                        <input type="date" class="form-input" th:field="*{startDate}" required />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Data fine</label>
                                        <input type="date" class="form-input" th:field="*{endDate}" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Tipo Contratto</label>
                                        <select class="form-select" th:field="*{contractType}">
                                            <option th:each="s : ${contractType}" th:value="${s}" th:text="${s.displayName}"></option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">RAL (â‚¬)</label>
                                        <input type="number" step="0.01" class="form-input" th:field="*{salary}" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Stato</label>
                                        <select class="form-select" th:field="*{status}">
                                            <option th:each="s : ${statuses}" th:value="${s}" th:text="${s.displayName}"></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Details -->
                        <div class="form-section" data-aos="fade-up" data-aos-delay="300">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="bi bi-briefcase"></i>
                                </div>
                                <h3 class="section-title">Inquadramento Professionale</h3>
                            </div>
                            <div class="section-body">
                                <div class="form-grid form-grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Mansione</label>
                                        <input class="form-input" type="text" th:field="*{jobRole}" placeholder="Inserisci la mansione" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Qualifica</label>
                                        <input class="form-input" type="text" th:field="*{jobTitle}" placeholder="Inserisci la qualifica" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">CCNL</label>
                                        <select class="form-select" th:field="*{ccnl}">
                                            <option th:each="c : ${ccnls}" th:value="${c}" th:text="${c.displayName}"></option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Livello</label>
                                        <input class="form-input" th:field="*{contractLevel}" />
                                    </div>
                                </div>
                            </div>
                        </div>
						<!-- Union Memberships -->
                        <div class="form-section" data-aos="fade-up" data-aos-delay="350">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="bi bi-people"></i>
                                </div>
                                <h3 class="section-title">Iscrizioni Sindacali</h3>
                            </div>
                            <div class="section-body">
                                <div class="mt-4">
                                    <h5>Iscrizioni Sindacali</h5>
                                    <table class="table table-striped" id="unionMembershipsTable">
                                        <thead>
                                            <tr>
                                                <th>Codice</th>
                                                <th>Sindacato</th>
                                                <th>Importo</th>
                                                <th>Dal</th>
                                                <th>Al</th>
                                                <th>RSA</th>
                                                <th>Dirigente</th>
                                                <th class="text-center">Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                           <tr th:each="u, stat : *{unionMemberships}">
                                                <td><input type="text" class="form-control" th:field="*{unionMemberships[__${stat.index}__].code}" /></td>
                                                <td>
                                                    <select class="form-select" th:field="*{unionMemberships[__${stat.index}__].unionDescription}">
                                                        <option value="">Seleziona...</option>
                                                        <option th:each="uOpt : ${unions}" th:value="${uOpt.name}" th:text="${uOpt.name}"></option>
                                                    </select>
                                                </td>
                                                <td><input type="number" step="0.01" class="form-control" th:field="*{unionMemberships[__${stat.index}__].deductionAmount}" /></td>
                                                <td><input type="date" class="form-control" th:field="*{unionMemberships[__${stat.index}__].startDate}" /></td>
                                                <td><input type="date" class="form-control" th:field="*{unionMemberships[__${stat.index}__].endDate}" /></td>
                                                <td class="text-center"><input type="checkbox" class="form-check-input" th:field="*{unionMemberships[__${stat.index}__].rsa}" /></td>
                                                <td class="text-center"><input type="checkbox" class="form-check-input" th:field="*{unionMemberships[__${stat.index}__].dirigente}" /></td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeUnionRow(this)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr th:if="${#lists.isEmpty(unionMemberships)}" class="empty-row">
                                                <td colspan="8" class="text-center text-muted">Nessuna iscrizione</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="addUnionRow()">Aggiungi riga</button>
                                    <select id="unionOptionsProto" class="d-none">
                                        <option value="">Seleziona...</option>
                                        <option th:each="uOpt : ${unions}" th:value="${uOpt.name}" th:text="${uOpt.name}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Workplace -->
                        <div class="form-section" data-aos="fade-up" data-aos-delay="400">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="bi bi-geo-alt"></i>
                                </div>
                                <h3 class="section-title">Luogo di Lavoro</h3>
                            </div>
                            <div class="section-body">
                                <div class="mt-4">
                                    <h5>Storico Luoghi di Lavoro</h5>
                                    <table class="table table-striped" id="workplacesTable">
                                        <thead>
                                            <tr>
                                                <th>Commessa</th>
                                                <th>Dal</th>
                                                <th>Al</th>
                                                <th class="text-center">Azioni</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                           <tr th:each="wp, stat : *{workplaces}">
                                                <td>
                                                    <select class="form-select" th:field="*{workplaces[__${stat.index}__].project.id}">
                                                        <option value="">Seleziona commessa...</option>
                                                        <option th:each="p : ${projects}" th:value="${p.id}"
                                                                th:text="${p.name}"></option>
                                                    </select>
                                                    <input type="hidden" th:field="*{workplaces[__${stat.index}__].id}" />
                                                </td>
                                                <td><input type="date" class="form-control" th:field="*{workplaces[__${stat.index}__].startDate}" /></td>
                                                <td><input type="date" class="form-control" th:field="*{workplaces[__${stat.index}__].endDate}" /></td>
                                                <td class="text-center">
                                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeWorkplaceRow(this)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr th:if="${#lists.isEmpty(workplaces)}" class="empty-row">
                                                <td colspan="4" class="text-center text-muted">Nessun luogo registrato</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                     <button type="button" class="btn btn-sm btn-secondary" onclick="addWorkplaceRow()">Aggiungi riga</button>
                                    <select id="projectOptionsProto" class="d-none">
                                        <option value="">Seleziona commessa...</option>
                                        <option th:each="p : ${projects}" th:value="${p.id}" th:text="${p.name}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Documents Tab -->
                <div class="tab-pane" id="docs-tab">
                    <div th:if="${employment.id != null}">
                        <div class="documents-section" data-aos="fade-up" data-aos-delay="100">
                            <div class="section-header">
                                <div class="section-icon">
                                    <i class="bi bi-folder2-open"></i>
                                </div>
                                <h3 class="section-title">Documenti per <span th:text="${employment.employee.firstName + ' ' + employment.employee.lastName}">Dipendente</span></h3>
                            </div>
                            <div class="section-body">
                                <!-- Modern Upload Form -->
                                <div class="upload-form-container">
                                    <h5 style="margin-bottom: var(--space-lg); color: var(--gray-700); text-align: center;">Carica un nuovo documento</h5>
                                    
                                    <!-- Main Upload Form -->
                                    <form id="document-upload-form" th:action="@{/fleet/employments/{id}/docs(id=${employment.id})}" method="post" enctype="multipart/form-data">
                                    	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <!-- Drag & Drop Zone + Form Fields in Row -->
                                        <div class="upload-row">
                                            <!-- File Upload Zone -->
                                            <div class="upload-zone-column">
                                                <label class="form-label">File documento *</label>
                                                <div class="modern-upload-zone" id="modernUploadZone">
                                                    <div class="upload-content">
                                                        <i class="bi bi-cloud-upload" id="uploadIcon"></i>
                                                        <span id="uploadText">Seleziona file o trascina qui</span>
                                                    </div>
                                                    <input type="file" name="file" id="fileInput" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.webp" style="display: none;" required />
                                                </div>
                                                <div class="selected-file-info" id="selectedFileInfo" style="display: none;">
                                                    <i class="bi bi-file-earmark" id="fileIcon"></i>
                                                    <div class="file-details">
                                                        <span class="file-name" id="fileName">documento.pdf</span>
                                                        <span class="file-size" id="fileSize">2.5 MB</span>
                                                    </div>
                                                    <button type="button" class="remove-file-btn" id="removeFileBtn">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Document Type -->
                                            <div class="form-column">
                                                <label class="form-label">Tipo documento *</label>
                                                <select name="type" class="form-select" required>
                                                    <option value="">Seleziona tipo...</option>
                                                    <option th:each="dt : ${docTypes}" th:value="${dt}" th:text="${dt.displayName}"></option>
                                                </select>
                                            </div>
                                            
                                            <!-- Issue Date -->
                                            <div class="form-column">
                                                <label class="form-label">Data emissione</label>
                                                <input type="date" name="issueDate" class="form-input" placeholder="gg/mm/aaaa" />
                                            </div>
                                            
                                            <!-- Expiry Date -->
                                            <div class="form-column">
                                                <label class="form-label">Data scadenza</label>
                                                <input type="date" name="expiryDate" class="form-input" placeholder="gg/mm/aaaa" />
                                            </div>
                                            
                                            <!-- Submit Button -->
                                            <div class="form-column submit-column">
                                                <label class="form-label" style="opacity: 0;">Submit</label>
                                                <button type="submit" class="btn btn-primary upload-btn">
                                                    <i class="bi bi-upload"></i>
                                                    Carica Documento
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Documents Table -->
                                <div class="documents-table">
                                    <div class="table-header" style="display: grid; grid-template-columns: 2fr 2fr 1.5fr 1.5fr 1fr; align-items: center;">
                                        <div>Tipo</div>
                                        <div>File</div>
                                        <div>Emesso il</div>
                                        <div>Scade il</div>
                                        <div style="text-align: center;">Azioni</div>
                                    </div>
                                    
                                    <div th:each="doc : ${documents}" class="table-row" style="display: grid; grid-template-columns: 2fr 2fr 1.5fr 1.5fr 1fr; align-items: center;">
                                        <div>
                                            <span class="type-badge type-badge-success" th:text="${doc.type.displayName}">Contratto</span>
                                        </div>
                                        <div>
                                            <div style="display: flex; align-items: center; gap: var(--space-sm);">
                                                <i class="bi bi-file-earmark-pdf" style="color: var(--danger-500);"></i>
                                                <span th:text="${doc.path.substring(doc.path.lastIndexOf('/')+1)}" style="font-weight: 500;">documento.pdf</span>
                                            </div>
                                        </div>
                                        <div th:text="${doc.issueDate} ? ${#temporals.format(doc.issueDate, 'dd/MM/yyyy')} : '-'" style="color: var(--gray-600);">-</div>
                                        <div th:text="${doc.expiryDate} ? ${#temporals.format(doc.expiryDate, 'dd/MM/yyyy')} : '-'" style="color: var(--gray-600);">-</div>
                                        <div class="table-actions" style="justify-content: center;">
                                            <a th:href="@{/fleet/employments/{empId}/docs/{fn}(empId=${employment.id},fn=${doc.path.substring(doc.path.lastIndexOf('/')+1)})}" 
                                               class="btn btn-sm btn-outline" title="Download">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            <a th:href="@{/fleet/employments/{empId}/docs/{docId}/delete(empId=${employment.id},docId=${doc.id})}" 
                                               class="btn btn-sm btn-outline" style="color: var(--danger-600); border-color: var(--danger-300);" 
                                               title="Elimina" onclick="return confirm('Sei sicuro di voler eliminare questo documento?');">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div th:if="${#lists.isEmpty(documents)}" class="table-row" style="grid-column: 1 / -1; text-align: center; padding: var(--space-2xl);">
                                        <div class="empty-state">
                                            <i class="bi bi-inbox" style="font-size: 3rem; color: var(--gray-300);"></i>
                                            <p style="color: var(--gray-500); margin-top: var(--space-md);">Nessun documento presente</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div th:if="${employment.id == null}" class="alert-info" data-aos="fade-up" data-aos-delay="100">
                        <i class="bi bi-info-circle-fill"></i>
                        <div>
                            <strong>Attenzione:</strong> Salva i dettagli del rapporto di lavoro per poter caricare i documenti.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" data-aos="fade-up" data-aos-delay="500">
                 <a class="btn btn-outline"
                   th:href="${returnQuery != null and !returnQuery.isEmpty()} ? @{|/fleet/employments${returnQuery}|} : @{/fleet/employments}">
                    <i class="bi bi-list-ul"></i>
                    Torna alla Lista
                </a>
                <div class="btn-group">
                    <a class="btn btn-secondary"
                       th:href="${returnQuery != null and !returnQuery.isEmpty()} ? @{|/fleet/employments${returnQuery}|} : @{/fleet/employments}">Annulla</a>
                    <button type="submit" class="btn btn-primary" form="employment-form">
                        <i th:class="${employment.id == null} ? 'bi bi-plus-circle' : 'bi bi-check-circle'"></i>
                        <span th:text="${employment.id == null ? 'Crea Rapporto' : 'Aggiorna Dettagli'}">Crea Rapporto</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            easing: 'ease-out-cubic',
            once: true,
            mirror: false
        });

        // Tab functionality with URL state management
        document.querySelectorAll('.modern-tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.disabled) return;
                
                // Remove active class from all buttons and panes
                document.querySelectorAll('.modern-tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Show corresponding pane
                const targetTab = this.getAttribute('data-tab');
                document.getElementById(targetTab + '-tab').classList.add('active');
                
                // Update URL without reloading page
                const url = new URL(window.location);
                url.searchParams.set('tab', targetTab);
                window.history.replaceState({}, '', url);
                
             // Refresh animations so action buttons appear in new tab
                AOS.refresh();
            });
        });

        // Initialize tab from URL parameter
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab');
            
            if (activeTab === 'docs' && document.querySelector('[data-tab="docs"]') && !document.querySelector('[data-tab="docs"]').disabled) {
                // Switch to docs tab
                document.querySelectorAll('.modern-tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                document.querySelector('[data-tab="docs"]').classList.add('active');
                document.getElementById('docs-tab').classList.add('active');
                
             // Ensure AOS recalculates positions when loading directly on docs tab
                AOS.refresh();
            }
        });
        
     // Gestione dinamica dei luoghi di lavoro
        const workplaceOptions = document.getElementById('projectOptionsProto').innerHTML;

        function addWorkplaceRow() {
            const tbody = document.querySelector('#workplacesTable tbody');
            const empty = tbody.querySelector('.empty-row');
            if (empty) {
                empty.remove();
            }
            const index = tbody.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select class="form-select" name="workplaces[${index}].project.id">
                        ${workplaceOptions}
                    </select>
                    <input type="hidden" name="workplaces[${index}].id" />
                </td>
                <td><input type="date" class="form-control" name="workplaces[${index}].startDate" /></td>
                <td><input type="date" class="form-control" name="workplaces[${index}].endDate" /></td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-danger" onclick="removeWorkplaceRow(this)"><i class="bi bi-trash"></i></button></td>`;
            tbody.appendChild(row);
        }

        function removeWorkplaceRow(btn) {
            const row = btn.closest('tr');
            const tbody = row.parentElement;
            row.remove();
            Array.from(tbody.children).forEach((tr, idx) => {
                tr.querySelectorAll('select, input').forEach(el => {
                    if (el.name && el.name.startsWith('workplaces[')) {
                        const suffix = el.name.substring(el.name.indexOf('].') + 2);
                        el.name = `workplaces[${idx}].${suffix}`;
                    }
                });
            });
            if (tbody.children.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.classList.add('empty-row');
                emptyRow.innerHTML = '<td colspan="4" class="text-center text-muted">Nessun luogo registrato</td>';
                tbody.appendChild(emptyRow);
            }
        }

     // Gestione dinamica delle iscrizioni sindacali
        const unionOptions = document.getElementById('unionOptionsProto').innerHTML;

        function addUnionRow() {
            const tbody = document.querySelector('#unionMembershipsTable tbody');
            const empty = tbody.querySelector('.empty-row');
            if (empty) {
                empty.remove();
            }
            const index = tbody.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="form-control" name="unionMemberships[${index}].code" /></td>
                <td>
                    <select class="form-select" name="unionMemberships[${index}].unionDescription">
                        ${unionOptions}
                    </select>
                </td>
                <td><input type="number" step="0.01" class="form-control" name="unionMemberships[${index}].deductionAmount" /></td>
                <td><input type="date" class="form-control" name="unionMemberships[${index}].startDate" /></td>
                <td><input type="date" class="form-control" name="unionMemberships[${index}].endDate" /></td>
                <td class="text-center"><input type="checkbox" class="form-check-input" name="unionMemberships[${index}].rsa" /></td>
                <td class="text-center"><input type="checkbox" class="form-check-input" name="unionMemberships[${index}].dirigente" /></td>
                <td class="text-center"><button type="button" class="btn btn-sm btn-danger" onclick="removeUnionRow(this)"><i class="bi bi-trash"></i></button></td>`;
            tbody.appendChild(row);
        }

        function removeUnionRow(btn) {
            const row = btn.closest('tr');
            const tbody = row.parentElement;
            row.remove();
            Array.from(tbody.children).forEach((tr, idx) => {
                tr.querySelectorAll('select, input').forEach(el => {
                    if (el.name && el.name.startsWith('unionMemberships[')) {
                        const suffix = el.name.substring(el.name.indexOf('].') + 2);
                        el.name = `unionMemberships[${idx}].${suffix}`;
                    }
                });
            });
            if (tbody.children.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.classList.add('empty-row');
                emptyRow.innerHTML = '<td colspan="8" class="text-center text-muted">Nessuna iscrizione</td>';
                tbody.appendChild(emptyRow);
            }
        }
        
        // Employee selection functionality
        const employeeSelect = document.getElementById('employeeSelect');
        const employeeInfoCard = document.getElementById('employeeInfoCard');
        const employeeAvatar = document.getElementById('employeeAvatar');
        const employeeName = document.getElementById('employeeName');
        const employeeAge = document.getElementById('employeeAge');
        const employeeGender = document.getElementById('employeeGender');

        function updateEmployeeInfo() {
            if (!employeeSelect || !employeeSelect.selectedOptions || employeeSelect.selectedOptions.length === 0) {
                employeeInfoCard.style.display = 'none';
                return;
            }
            
            const option = employeeSelect.selectedOptions[0];
            if (!option || !option.value) {
                employeeInfoCard.style.display = 'none';
                return;
            }

            const name = option.textContent;
            const birthDate = option.getAttribute('data-birthdate');
            const gender = option.getAttribute('data-gender');

            // Update employee name and avatar
            employeeName.textContent = name;
            employeeAvatar.textContent = name.charAt(0).toUpperCase();

            // Update gender
            const genderText = gender === 'MALE' ? 'Uomo' : gender === 'FEMALE' ? 'Donna' : 'N/D';
            employeeGender.textContent = `Sesso: ${genderText}`;

            // Calculate and update age
            if (birthDate) {
                const diff = Date.now() - new Date(birthDate).getTime();
                const age = Math.floor(diff / 31557600000); // 365.25 days in ms
                employeeAge.textContent = `EtÃ : ${age} anni`;
            } else {
                employeeAge.textContent = 'EtÃ : N/D';
            }

            // Show the info card with animation
            employeeInfoCard.style.display = 'block';
            employeeInfoCard.setAttribute('data-aos', 'fade-up');
            AOS.refresh();
        }

        if (employeeSelect) {
            employeeSelect.addEventListener('change', updateEmployeeInfo);
            document.addEventListener('DOMContentLoaded', updateEmployeeInfo);
        }

        // Add form ID to main form for submit button - REMOVED (now handled in HTML)
        // const mainForm = document.querySelector('form[th\\:object]');
        // if (mainForm) {
        //     mainForm.id = 'employment-form';
        // }

        // Simplified Upload System - matching your design
        const modernUploadZone = document.getElementById('modernUploadZone');
        const fileInput = document.getElementById('fileInput');
        const selectedFileInfo = document.getElementById('selectedFileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileIcon = document.getElementById('fileIcon');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const uploadText = document.getElementById('uploadText');
        const uploadForm = document.getElementById('document-upload-form');

        if (modernUploadZone && fileInput) {
            // Click to select file
            modernUploadZone.addEventListener('click', () => {
                fileInput.click();
            });

            // Drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                modernUploadZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                modernUploadZone.addEventListener(eventName, () => {
                    modernUploadZone.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                modernUploadZone.addEventListener(eventName, () => {
                    modernUploadZone.classList.remove('dragover');
                }, false);
            });

            modernUploadZone.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }

            function handleFileSelect(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            }

            function handleFile(file) {
                // Validate file size (10MB max)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Il file Ã¨ troppo grande. Dimensione massima: 10MB');
                    return;
                }
                
             // Attach dropped file to the hidden input so it gets submitted
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;

                // Update file info
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                
                // Update file icon based on type
                const extension = file.name.split('.').pop().toLowerCase();
                const iconMap = {
                    'pdf': 'bi-file-earmark-pdf',
                    'doc': 'bi-file-earmark-word',
                    'docx': 'bi-file-earmark-word',
                    'jpg': 'bi-file-earmark-image',
                    'jpeg': 'bi-file-earmark-image',
                    'png': 'bi-file-earmark-image'
                };
                
                fileIcon.className = `bi ${iconMap[extension] || 'bi-file-earmark'}`;
                
                // Update upload zone appearance
                modernUploadZone.classList.add('has-file');
                uploadText.textContent = `File selezionato: ${file.name}`;
                uploadText.style.color = 'var(--success-600)';
                
                // Show file info
                selectedFileInfo.style.display = 'flex';
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            // Remove file button
            removeFileBtn?.addEventListener('click', () => {
                resetUploadForm();
            });

            function resetUploadForm() {
                fileInput.value = '';
                modernUploadZone.classList.remove('has-file');
                uploadText.textContent = 'Seleziona file o trascina qui';
                uploadText.style.color = '';
                selectedFileInfo.style.display = 'none';
            }
        }

        // Form submission with tab redirect
        if (uploadForm) {
        	uploadForm.addEventListener('submit', function() {
                // Add tab parameter to maintain docs tab after upload
              
                // Create hidden input for tab redirect
                const tabInput = document.createElement('input');
                tabInput.type = 'hidden';
                tabInput.name = '_tab';
                tabInput.value = 'docs';
                this.appendChild(tabInput);
            });
        }

        // Add ripple effect to buttons
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple');
                
                this.style.position = 'relative';
                this.style.overflow = 'hidden';
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        });

        // Form validation enhancements
        const formInputs = document.querySelectorAll('.form-input, .form-select');
        formInputs.forEach(input => {
            input.addEventListener('invalid', function() {
                this.style.borderColor = 'var(--danger-500)';
                this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            });
            
            input.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.style.borderColor = 'var(--success-500)';
                    this.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
                } else {
                    this.style.borderColor = 'var(--gray-300)';
                    this.style.boxShadow = '';
                }
            });
        });

        // Auto-save draft functionality (optional)
        let autoSaveTimer;
               
        function autoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                // Save form data to localStorage as draft
                const form = document.getElementById('employment-form');
                if (form) {
                    const data = new FormData(form);
                    const draft = {};
                    for (let [key, value] of data.entries()) {
                        draft[key] = value;
                    }
                    localStorage.setItem('employment_draft', JSON.stringify(draft));
                    
                    // Show save indicator
                    showSaveIndicator();
                }
            }, 2000);
        }

        function showSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.innerHTML = '<i class="bi bi-check-circle"></i> Bozza salvata automaticamente';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-500);
                color: white;
                padding: var(--space-md);
                border-radius: var(--radius-md);
                font-size: 0.875rem;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;
            
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => indicator.remove(), 300);
            }, 2000);
        }

        // Attach auto-save to form inputs
        formInputs.forEach(input => {
            input.addEventListener('input', autoSave);
            input.addEventListener('change', autoSave);
        });

        // Add CSS animations for save indicator
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
	</body>
</html>