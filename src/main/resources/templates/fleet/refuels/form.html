<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it"
      th:replace="~{fragments/layoutNavBar :: layout(~{::title}, ~{::body}, ~{::cssblock}, ~{::navbar})}">
<head>
    <title th:text="${refuel.id == null ? 'Nuovo Rifornimento' : 'Modifica Rifornimento'}">Rifornimento</title>
    <th:block th:fragment="cssblock">
        <link rel="stylesheet" th:href="@{/css/refuels-form.css}">
    </th:block>
</head>
<th:block th:fragment="navbar">
	<h2 class="form-title">
	    <span class="title-icon">
	        <i class="bi bi-ev-station"></i>
	    </span>
	    <span th:text="${refuel.id == null ? 'Nuovo Rifornimento' : 'Modifica Rifornimento'}"></span>
		<i class="form-subtitle" th:text="${refuel.id == null ? 'Registra un nuovo rifornimento per il parco auto' : 'Modifica i dati del rifornimento selezionato'}"></i>
	</h2>
	<!-- Breadcrumb Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-3">
                <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                <li class="breadcrumb-item"><a th:href="@{/fleet/refuels}">Rifornimenti</a></li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${refuel.id == null ? 'Nuovo' : 'Modifica'}"></li>
            </ol>
        </nav>
    </div>
</th:block>
<body>
<main class="container my-5 flex-fill" style="max-width: 1200px;">
    <!-- Form Container -->
    <div class="refuel-form-container fade-in">
        <!-- Form Header -->
        

        <!-- Form Body -->
        <form th:object="${refuel}"
              th:action="${refuel.id == null} ? @{/fleet/refuels/new} : @{/fleet/refuels/{id}/edit(id=${refuel.id})}"
              method="post" id="refuelForm" class="needs-validation" novalidate>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            
            <div class="form-body">
                <!-- Sezione Informazioni Base -->
                <div class="form-section slide-up">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <div>
                            <h3 class="section-title">Informazioni Base</h3>
                            <p class="section-description">Data e veicolo del rifornimento</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="form-field">
                                <label class="form-label required" for="date">Data Rifornimento</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="date"
                                       th:field="*{date}" 
                                       required/>
                                <div class="invalid-feedback">
                                    <i class="bi bi-exclamation-circle feedback-icon"></i>
                                    Seleziona una data valida
                                </div>
                                <div class="field-helper">
                                    <i class="bi bi-info-circle helper-icon"></i>
                                    La data non può essere futura
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="form-field">
                                <label class="form-label required" for="vehicle">Veicolo</label>
                                <select class="form-control form-select"
                                        id="vehicle"
                                        th:field="*{vehicle.id}"
                                        required>
                                    <option value="">-- Seleziona veicolo --</option>
                                    <option th:each="v : ${vehicles}"
                                            th:value="${v.id}"
                                            th:data-card-id="${v.fuelCard != null ? v.fuelCard.id : ''}"
                                            th:text="${v.brand + ' ' + v.model + ' (' + v.plate + ')'}"></option>
                                </select>
                                <div class="invalid-feedback">
                                    <i class="bi bi-exclamation-circle feedback-icon"></i>
                                    Seleziona un veicolo
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Dati Carburante -->
                <div class="form-section slide-up">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="bi bi-fuel-pump"></i>
                        </div>
                        <div>
                            <h3 class="section-title">Dati Carburante</h3>
                            <p class="section-description">Quantità, importo e carta utilizzata</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <div class="form-field">
                                <label class="form-label required" for="quantity">
                                    Quantità
                                    <span class="label-helper">(litri)</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control decimal-field" 
                                           id="quantity"
                                           th:field="*{quantity}" 
                                           required
                                           placeholder="45,50" 
                                           inputmode="decimal" 
                                           pattern="\d+(,\d{1,2})?"
                                           data-calculation-source="true"/>
                                    <span class="input-group-text">L</span>
                                </div>
                                <div class="invalid-feedback">
                                    <i class="bi bi-exclamation-circle feedback-icon"></i>
                                    Usa la virgola come separatore decimale (es: 45,50)
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="form-field">
                                <label class="form-label required" for="amount">
                                    Importo Totale
                                    <span class="label-helper">(euro)</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control decimal-field" 
                                           id="amount"
                                           th:field="*{amount}" 
                                           required
                                           placeholder="67,80" 
                                           inputmode="decimal" 
                                           pattern="\d+(,\d{1,2})?"
                                           data-calculation-source="true"/>
                                    <span class="input-group-text">€</span>
                                </div>
                                <div class="invalid-feedback">
                                    <i class="bi bi-exclamation-circle feedback-icon"></i>
                                    Usa la virgola come separatore decimale (es: 67,80)
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="form-field">
                                <label class="form-label" for="pricePerLiter">
                                    Prezzo al Litro
                                    <span class="label-helper">(calcolato automaticamente)</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control calculated-field" 
                                           id="pricePerLiter"
                                           readonly
                                           placeholder="1,49"/>
                                    <span class="input-group-text">€/L</span>
                                </div>
                                <div class="field-helper">
                                    <i class="bi bi-calculator helper-icon"></i>
                                    Calcolato automaticamente da importo ÷ quantità
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-4 mt-2">
                        <div class="col-lg-6">
                            <div class="form-field">
                                <label class="form-label" for="fuelCard">Carta Carburante</label>
                                <select class="form-control form-select" 
                                        id="fuelCard"
                                        th:field="*{fuelCard.id}">
                                    <option value="">-- Nessuna carta utilizzata --</option>
                                    <option th:each="c : ${fuelCards}" 
                                            th:value="${c.id}" 
                                            th:text="${c.cardNumber}"></option>
                                </select>
                                <div class="field-helper">
                                    <i class="bi bi-credit-card helper-icon"></i>
                                    Opzionale - seleziona se è stata utilizzata una carta carburante
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Dati Aggiuntivi -->
                <div class="form-section slide-up">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="bi bi-speedometer2"></i>
                        </div>
                        <div>
                            <h3 class="section-title">Dati Aggiuntivi</h3>
                            <p class="section-description">Chilometraggio del veicolo</p>
                        </div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="form-field">
                                <label class="form-label" for="mileage">
                                    Chilometraggio Attuale
                                    <span class="label-helper">(km)</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control numeric-field" 
                                           id="mileage"
                                           th:field="*{mileage}"
                                           placeholder="120000"
                                           inputmode="numeric" 
                                           pattern="\d+"/>
                                    <span class="input-group-text">km</span>
                                </div>
                                <div class="invalid-feedback" th:if="${!#fields.hasErrors('mileage')}">
                                    <i class="bi bi-exclamation-circle feedback-icon"></i>
                                    Inserisci solo numeri senza punti o virgole
                                </div>
                                <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('mileage')}" th:errors="*{mileage}"></div>
                                <div class="field-helper">
                                    <i class="bi bi-info-circle helper-icon"></i>
                                    Chilometraggio del veicolo al momento del rifornimento
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a class="btn-cancel" th:href="@{/fleet/refuels}">
                    <i class="bi bi-x-lg"></i>
                    Annulla
                </a>
                <button type="submit" class="btn-submit me-4">
                    <i th:class="${refuel.id == null} ? 'bi bi-check-lg' : 'bi bi-pencil-square'"></i>
                    <span th:text="${refuel.id == null ? 'Crea Rifornimento' : 'Aggiorna Rifornimento'}"></span>
                </button>
            </div>
        </form>
    </div>
</main>
<!-- Enhanced JavaScript -->
<script th:src="@{/js/refuels-form.js}"></script>
<!-- Include refuels.js if it contains additional functionality -->
<script th:src="@{/js/refuels.js}"></script>
</body>
</html>