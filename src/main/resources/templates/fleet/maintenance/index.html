<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it"
      th:replace="~{fragments/layoutNavBar :: layout(~{::title}, ~{::body}, ~{::cssblock}, ~{::navbar})}">
<head>
    <title>Manutenzioni – Veely</title>
    <th:block th:fragment="cssblock">
        <link rel="stylesheet" th:href="@{/css/maintenance.css}">
    </th:block>
</head>
<th:block th:fragment="navbar">
 <!-- Header -->
    <div>
	    <div class="d-flex fs-2 m-2">
	       	<div class="bg-primary me-2 rounded text-white shadow-md text-center p-2"><i class="bi bi-car-front m-2"></i></div>
	       	<p class="fw-bold mb-0">Manutenzioni</p>
	    </div>
	        <p>Storico e pianificazione interventi</p>
    </div>
	<a th:href="@{/fleet/maintenance/new}" class="btn btn-primary" data-aos="zoom-in" data-aos-delay="200">
	    <i class="bi bi-wrench-adjustable"></i> Nuova Manutenzione
	</a>

</th:block>
<body>
<main class="page-content">
	 <!-- KPI Manutenzioni -->
    <div class="stats-grid mb-4">
        <!-- Totale manutenzioni -->
        <div class="stat-card primary-card" data-aos="scale-up" data-aos-delay="100">
            <div class="stat-card-header">
                <div class="stat-icon primary">
                    <i class="bi bi-tools"></i>
                </div>
            </div>
            <div class="stat-content">
                <p class="stat-label">Totale Interventi</p>
                <h3 class="stat-value" th:text="${totalMaintenances}">0</h3>
                <span class="stat-trend neutral">
                    <i class="bi bi-calendar"></i> Anno in corso
                </span>
            </div>
        </div>

        <!-- Costo totale -->
        <div class="stat-card warning-card" data-aos="scale-up" data-aos-delay="200">
            <div class="stat-card-header">
                <div class="stat-icon warning">
                    <i class="bi bi-currency-euro"></i>
                </div>
            </div>
            <div class="stat-content">
                <p class="stat-label">Spesa Totale</p>
                <h3 class="stat-value" th:text="${#numbers.formatCurrency(totalCost)}">€0</h3>
                <span class="stat-trend warning">
                    <i class="bi bi-graph-up"></i> Anno in corso
                </span>
            </div>
        </div>

        <!-- Media costo intervento -->
        <div class="stat-card info-card" data-aos="scale-up" data-aos-delay="300">
            <div class="stat-card-header">
                <div class="stat-icon info">
                    <i class="bi bi-calculator"></i>
                </div>
            </div>
            <div class="stat-content">
                <p class="stat-label">Costo Medio</p>
                <h3 class="stat-value" th:text="${#numbers.formatCurrency(avgCost)}">€0</h3>
                <span class="stat-trend neutral">
                    <i class="bi bi-tools"></i> Per intervento
                </span>
            </div>
        </div>
    </div>
    
     <!-- Lista manutenzioni -->
    <div class="table-card fade-in" data-aos="fade-up" data-aos-delay="100">
       

        <!-- Filtro -->
        <form class="row g-3 px-4 pt-3" method="get" th:action="@{/fleet/maintenance}" data-aos="fade-up" data-aos-delay="250">
            <div class="col-md-4">
                <label class="form-label">Targa</label>
                <input type="text" name="plate" class="form-control" th:value="${param.plate}" placeholder="Es. AA000AA">
            </div>
            <div class="col-md-2">
                <label class="form-label">Anno</label>
                <input type="number" name="year" class="form-control" th:value="${param.year != null ? param.year[0] : T(java.time.LocalDate).now().year}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Tipo</label>
                <select name="typeId" class="form-select">
                    <option value="" th:selected="${param.typeId == null}">Tutti</option>
                    <option th:each="t : ${types}" th:value="${t.id}" th:selected="${param.typeId != null and param.typeId[0] == t.id}" th:text="${t.description}"></option>
                </select>
            </div>
            <div class="col-12 col-lg-3 d-flex gap-2 align-items-end">
                <button type="submit" class="btn btn-outline-secondary flex-fill">
                    <i class="bi bi-search"></i> Filtra
                </button>
                <a th:href="@{/fleet/maintenance}" class="btn btn-outline-danger" title="Reset filtri">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </form>

        <!-- Tabella -->
        <div class="table-content modern-table" data-aos="fade-up" data-aos-delay="300">
            <table class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Veicolo</th>
                        <th>Tipo</th>
                        <th class="text-end">Km</th>
                        <th class="text-end">Costo</th>
                        <th class="text-end">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="m : ${maintenances}" class="table-row hover-animate">
                        <td class="date-text" th:text="${m.date}"></td>
                        <td>
                            <div class="vehicle-info">
                                <span class="vehicle-plate" th:text="${m.vehicle.plate}"></span>
                                <span class="vehicle-model" th:text="${m.vehicle.model}"></span>
                            </div>
                        </td>
                        <td>
                            <span class="type-badge"
                                  th:classappend="${m.type != null && m.type.description == 'Tagliando' ? ' type-badge-success' :
                                                   m.type != null && m.type.description == 'Riparazione' ? ' type-badge-warning' :
                                                   m.type != null && m.type.description == 'Sostituzione' ? ' type-badge-danger' : ''}"
                                  th:text="${m.type != null ? m.type.description : '-'}"></span>
                        </td>
                        <td class="text-end km-text" th:text="${m.mileage}"></td>
                        <td class="text-end" th:text="${#numbers.formatCurrency(m.cost)}"></td>
                       <td class="text-end cell-actions">
						  <a th:href="@{|/fleet/maintenance/${m.id}/edit|}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form th:action="@{|/fleet/maintenance/${m.id}/delete|}" method="post" class="d-inline" onsubmit="return confirm('Eliminare?');">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
						</td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(maintenances)}" class="empty-row">
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="bi bi-tools"></i>
                                <span>Nessuna manutenzione registrata</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>AOS.init({ once: true, duration: 600, easing: 'ease-out' });</script>
</body>
</html>