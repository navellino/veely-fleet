<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it"
      th:replace="~{fragments/layout_new :: layout(~{::title}, ~{::body}, ~{::cssblock})}">
<head>
  <title th:text="${maintenance.id == null ? 'Nuova Manutenzione' : 'Modifica Manutenzione'}">Manutenzione</title>
  <th:block th:fragment="cssblock">
    <link rel="stylesheet" th:href="@{/css/maintenance-form.css}">
  </th:block>
</head>
<body>
<main class="page-content">
  
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title" th:text="${maintenance.id == null ? 'Nuova Manutenzione' : 'Modifica Manutenzione'}"></h1>
        <p class="page-subtitle">Inserisci i dettagli dell’intervento e allega eventuali documenti</p>
      </div>
      <div class="header-actions">
        <a th:href="@{/fleet/maintenance}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left-short"></i> Torna all’elenco
        </a>
      </div>
    </div>
  </div>

  <!-- Card form -->
  <div class="table-card" data-aos="fade-up" data-aos-delay="50">
    <div class="table-header">
      <div>
        <h2 class="table-title">Dettagli intervento</h2>
        <p class="table-subtitle">Campi principali per la registrazione</p>
      </div>
    </div>

    <div class="table-content">
      <form th:object="${maintenance}"
            th:action="${maintenance.id == null} ? @{/fleet/maintenance/new} : @{/fleet/maintenance/{id}/edit(id=${maintenance.id})}"
            method="post" class="modern-form-grid" data-aos="fade-up" data-aos-delay="100">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- Sezione 1 -->
        <div class="form-section">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Data <span class="req">*</span></label>
              <input type="date" class="form-control" th:field="*{date}" required>
            </div>

            <div class="col-md-8">
              <label class="form-label">Veicolo <span class="req">*</span></label>
              <select class="form-select" th:field="*{vehicle.id}" required>
                <option value="" disabled selected>Seleziona veicolo…</option>
                <option th:each="v : ${vehicles}" th:value="${v.id}" th:text="${v.brand + ' ' + v.model + ' (' + v.plate + ')'}"></option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Tipo <span class="req">*</span></label>
              <select class="form-select" th:field="*{type.id}" required>
                <option value="" disabled selected>Seleziona tipo…</option>
                <option th:each="t : ${types}" th:value="${t.id}" th:text="${t.description}"></option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Fornitore</label>
              <select class="form-select" th:field="*{supplier.id}">
                <option value="">Nessuno</option>
                <option th:each="s : ${suppliers}" th:value="${s.id}" th:text="${s.name}"></option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Chilometraggio</label>
              <div class="input-with-suffix">
                <input type="number" min="0" class="form-control" th:field="*{mileage}">
                <span class="suffix">km</span>
              </div>
               <div class="text-danger" th:if="${#fields.hasErrors('mileage')}" th:errors="*{mileage}"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Costo</label>
              <div class="input-group">
                <input type="number" step="0.01" min="0" class="form-control" th:field="*{cost}">
                <span class="input-group-text">€</span>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Descrizione</label>
              <textarea class="form-control" rows="3" th:field="*{description}" placeholder="Es. Tagliando completo con sostituzione filtri…"></textarea>
            </div>
          </div>
        </div>

        <!-- Azioni sticky -->
        <div class="form-actions">
          <div class="actions-left">
            <a class="btn btn-outline-secondary" th:href="@{/fleet/maintenance}">
              <i class="bi bi-x-lg"></i> Annulla
            </a>
          </div>
          <div class="actions-right">
            <button type="submit" name="redirect" value="" class="btn btn-primary">
              <i th:class="${maintenance.id == null} ? 'bi bi-check-lg' : 'bi bi-pencil-square'"></i>
              <span th:text="${maintenance.id == null ? 'Salva' : 'Aggiorna'}"></span>
            </button>
            <button type="submit" name="redirect" value="vehicle" class="btn btn-outline-primary">
              <i class="bi bi-check2-circle"></i> Salva e vai al Veicolo
            </button>
            <a class="btn btn-success" th:href="${maintenance.id != null} ? @{/fleet/maintenance/new} : '#'"
               th:classappend="${maintenance.id == null}? ' disabled'">
              <i class="bi bi-plus-lg"></i> Nuova
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Documenti -->
  <div th:if="${maintenance.id != null}" class="table-card mt-4" data-aos="fade-up" data-aos-delay="100">
    <div class="table-header">
      <div>
        <h2 class="table-title">Documenti manutenzione</h2>
        <p class="table-subtitle">Carica fatture, preventivi o altri allegati</p>
      </div>
    </div>

    <div class="table-content">
      <form class="row g-3 p-3 doc-upload"
            th:action="@{/fleet/maintenance/{id}/docs(id=${maintenance.id})}"
            method="post" enctype="multipart/form-data">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="col-md-5">
          <label class="form-label">File <span class="req">*</span></label>
          <input type="file" name="file" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Emesso il</label>
          <input type="date" name="issueDate" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">Scade il</label>
          <input type="date" name="expiryDate" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select name="type" class="form-select">
            <option th:each="dt : ${docTypes}" th:value="${dt}" th:text="${dt.displayName}"></option>
          </select>
        </div>
        <div class="col-md-1 d-grid align-self-end">
          <button type="submit" class="btn btn-success"><i class="bi bi-upload"></i></button>
        </div>
      </form>

      <div class="modern-table">
        <table class="table align-middle mb-0">
          <thead>
          <tr>
            <th>Tipo</th>
            <th>File</th>
            <th>Emesso</th>
            <th>Scadenza</th>
            <th class="text-end">Azioni</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="doc : ${documents}" class="table-row">
            <td th:text="${doc.type.displayName}"></td>
            <td th:text="${doc.path.substring(doc.path.lastIndexOf('/')+1)}"></td>
            <td th:text="${doc.issueDate} ? ${#temporals.format(doc.issueDate, 'dd/MM/yyyy')} : '-'">-</td>
            <td th:text="${doc.expiryDate} ? ${#temporals.format(doc.expiryDate, 'dd/MM/yyyy')} : '-'">-</td>
            <td class="text-end cell-actions">
              <a th:href="@{/fleet/maintenance/{id}/docs/{fn}(id=${maintenance.id},fn=${doc.path.substring(doc.path.lastIndexOf('/')+1)})}"
                 class="btn btn-sm btn-outline-primary" title="Download">
                <i class="bi bi-download"></i>
              </a>
              <a th:href="@{/fleet/maintenance/{mId}/docs/{docId}/delete(mId=${maintenance.id},docId=${doc.id})}"
                 class="btn btn-sm btn-outline-danger" title="Elimina"
                 onclick="return confirm('Eliminare questo documento?');">
                <i class="bi bi-trash"></i>
              </a>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(documents)}" class="empty-row">
            <td colspan="5">
              <div class="empty-state">
                <i class="bi bi-inbox"></i><span>Nessun documento presente</span>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div th:if="${maintenance.id == null}" class="alert alert-info mt-4" data-aos="fade-up">
    <i class="bi bi-info-circle-fill me-1"></i> Salva la manutenzione per poter caricare i documenti.
  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>AOS.init({ once: true, duration: 600, easing: 'ease-out' });</script>
</body>
</html>